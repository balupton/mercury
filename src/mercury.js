(function(){var a;window.top.Mercury!=null&&window.top.Mercury.loaded!=null?window.mercuryWindow=window.top:(window.mercuryWindow=window,a=window.Mercury=jQuery.extend(!0,{silent:!1,debug:!0,config:{editor:"inline",cleanStylesOnPaste:!0,snippets:{optionsUrl:"/mercury/snippets/:name/options",previewUrl:"/mercury/snippets/:name/preview"},uploading:{enabled:"local",allowedMimeTypes:["image/jpeg","image/gif","image/png"],maxFileSize:1235242880,inputName:"image[image]",url:"/images",handler:!1},toolbars:{primary:{save:["Save","Save this page"],preview:["Preview","Preview this page",{toggle:!0,mode:!0}],sep1:" ",undoredo:{undo:["Undo","Undo your last action"],redo:["Redo","Redo your last action"],sep:" "},insertLink:["Link","Insert Link",{modal:"/mercury/modals/link",regions:["rich","markupable"]}],insertMedia:["Media","Insert Media (images and videos)",{modal:"/mercury/modals/media",regions:["rich","markupable"]}],insertTable:["Table","Insert Table",{modal:"/mercury/modals/table",regions:["rich","markupable"]}],insertCharacter:["Character","Special Characters",{modal:"/mercury/modals/character",regions:["rich","markupable"]}],snippetPanel:["Snippet","Snippet Panel",{panel:"/mercury/panels/snippets"}],sep2:" ",historyPanel:["History","Page Version History",{panel:"/mercury/panels/history"}],sep3:" ",notesPanel:["Notes","Page Notes",{panel:"/mercury/panels/notes"}]},simple:{_regions:["basic","rich","markupable"],predefined:{style:["Style",null,{select:"/mercury/selects/style",preload:!0}],sep1:" ",formatblock:["Block Format",null,{select:"/mercury/selects/formatblock",preload:!0}],sep2:"-"},colors:{backColor:["Background Color",null,{palette:"/mercury/palettes/backcolor",context:!0,preload:!0,regions:["basic","rich"]}],sep1:" ",foreColor:["Text Color",null,{palette:"/mercury/palettes/forecolor",context:!0,preload:!0,regions:["basic","rich"]}],sep2:"-"},decoration:{bold:["Bold",null,{context:!0}],italic:["Italicize",null,{context:!0}],overline:["Overline",null,{context:!0,regions:["basic","rich"]}],strikethrough:["Strikethrough",null,{context:!0,regions:["basic","rich"]}],underline:["Underline",null,{context:!0,regions:["basic","rich"]}],sep:"-"},script:{subscript:["Subscript",null,{context:!0}],superscript:["Superscript",null,{context:!0}]}},editable:{_regions:["rich","markupable"],justify:{justifyLeft:["Align Left",null,{context:!0,regions:["rich"]}],justifyCenter:["Center",null,{context:!0,regions:["rich"]}],justifyRight:["Align Right",null,{context:!0,regions:["rich"]}],justifyFull:["Justify Full",null,{context:!0,regions:["rich"]}],sep:"-"},list:{insertUnorderedList:["Unordered List",null,{context:!0}],insertOrderedList:["Numbered List",null,{context:!0}],sep:"-"},indent:{outdent:["Decrease Indentation",null],indent:["Increase Indentation",null],sep:"-"},table:{_context:!0,insertRowBefore:["Insert Table Row","Insert a table row before the cursor",{regions:["rich"]}],insertRowAfter:["Insert Table Row","Insert a table row after the cursor",{regions:["rich"]}],deleteRow:["Delete Table Row","Delete this table row",{regions:["rich"]}],insertColumnBefore:["Insert Table Column","Insert a table column before the cursor",{regions:["rich"]}],insertColumnAfter:["Insert Table Column","Insert a table column after the cursor",{regions:["rich"]}],deleteColumn:["Delete Table Column","Delete this table column",{regions:["rich"]}],sep1:" ",increaseColspan:["Increase Cell Columns","Increase the cells colspan"],decreaseColspan:["Decrease Cell Columns","Decrease the cells colspan and add a new cell"],increaseRowspan:["Increase Cell Rows","Increase the cells rowspan"],decreaseRowspan:["Decrease Cell Rows","Decrease the cells rowspan and add a new cell"],sep2:"-"},rules:{horizontalRule:["Horizontal Rule","Insert a horizontal rule"],sep1:"-"},formatting:{removeFormatting:["Remove Formatting","Remove formatting for the selection",{regions:["rich"]}],sep2:" "},editors:{htmlEditor:["Edit HTML","Edit the HTML content",{regions:["rich"]}]}},snippetable:{_custom:!0,actions:{editSnippet:["Edit Snippet Settings",null],sep1:" ",removeSnippet:["Remove Snippet",null]}}},behaviors:{horizontalRule:function(a){return a.replace("<hr/>")},htmlEditor:function(){return a.modal("/mercury/modals/htmleditor",{title:"HTML Editor",fullHeight:!0,handler:"htmlEditor"})}},injectedStyles:'.mercury-region, .mercury-textarea { min-height: 10px; outline: 1px dotted #09F }.mercury-textarea { box-sizing: border-box; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; resize: vertical; }.mercury-region:focus, .mercury-region.focus, .mercury-textarea.focus { outline: none; -webkit-box-shadow: 0 0 10px #09F, 0 0 1px #045; box-shadow: 0 0 10px #09F, 0 0 1px #045 }.mercury-region:after { content: "."; display: block; visibility: hidden; clear: both; height: 0; overflow: hidden; }.mercury-region table, .mercury-region td, .mercury-region th { border: 1px dotted red; }'},Regions:{},modalHandlers:{},dialogHandlers:{},preloadedViews:{}},window.Mercury||{},{version:"0.2.0",supported:document.getElementById&&document.designMode&&!jQuery.browser.konqueror&&!jQuery.browser.msie,bind:function(a,b){return jQuery(document).bind("mercury:"+a,b)},trigger:function(b,c){a.log(b,c);return jQuery(document).trigger("mercury:"+b,c)},log:function(){if(a.debug&&console){if(arguments[0]==="hide:toolbar"||arguments[0]==="show:toolbar")return;try{return console.debug(arguments)}catch(b){}}}}))}).call(this),function(){String.prototype.titleize=function(){return this[0].toUpperCase()+this.slice(1)},String.prototype.toHex=function(){return this[0]==="#"?this:this.replace(/rgba?\((\d+)[\s|\,]?\s(\d+)[\s|\,]?\s(\d+)\)/gi,function(a,b,c,d){return"#"+parseInt(b).toHex()+parseInt(c).toHex()+parseInt(d).toHex()})},String.prototype.singleDiff=function(a){var b,c,d,e,f;c="";for(d=0,f=a.length;d<f;d++){b=a[d];if(b==="each")break;if(b!==this[d]){e=new RegExp(this.substr(d).regExpEscape().replace(/^\s+|^(&nbsp;)+/g,"")+"$","m"),c=a.substr(d).replace(e,"");break}}return c},String.prototype.regExpEscape=function(){var a,b;b=["/",".","*","+","?","|","(",")","[","]","{","}","\\"],a=new RegExp("(\\"+b.join("|\\")+")","g");return this.replace(a,"\\$1")},String.prototype.sanitizeHTML=function(){var a,b;b=jQuery("<div>").html(this.toString()),b.find("style").remove(),a=b.text(),a=a.replace(/\n+/g,"<br/>").replace(/.*<!--.*-->/g,"").replace(/^(<br\/>)+|(<br\/>\s*)+$/g,"");return a},Number.prototype.toHex=function(){var a;a=this.toString(16).toUpperCase();return a[1]?a:"0"+a},Number.prototype.toBytes=function(){var a,b;a=parseInt(this),b=0;while(1023<a)a/=1024,b+=1;return b?""+a.toFixed(2)+[""," kb"," Mb"," Gb"," Tb"," Pb"," Eb"][b]:""+a+" bytes"}}.call(this),function(){var a,b,c,d,e,f,g,h;(e=(a=$.fn).firedPromiseEvent)!=null?e:a.firedPromiseEvent=function(a){var b,c;b=$(this),c=b.data("defer-"+a+"-resolved")?!0:!1;return c},(f=(b=$.fn).createPromiseEvent)!=null?f:b.createPromiseEvent=function(a){var b,c,d;b=$(this);if(typeof b.data("defer-"+a+"-resolved")!="undefined")return b;b.data("defer-"+a+"-resolved",!1),d=$.fn.createPromiseEvent.events=$.fn.createPromiseEvent.events||{bind:function(c){b=$(this);return b.bind(a,c)},trigger:function(c){var d,e;b=$(this),d=b.data("defer-"+a),d||(e=$.event.special[a],e.setup.call(this),d=b.data("defer-"+a)),b.data("defer-"+a+"-resolved",!0),d.resolve(),c.preventDefault(),c.stopImmediatePropagation(),c.stopPropagation();return b},setup:function(c,d){b=$(this);return b.data("defer-"+a,new $.Deferred)},teardown:function(c){b=$(this);return b.data("defer-"+a,null)},add:function(c){var d,e;b=$(this),d=b.data("defer-"+a),e=$.event.special[a];if(!d){e.setup.call(this);return e.add.apply(this,[c])}return d.done(c.handler)},remove:function(a){}},c=[],$.each((b.data("events")||{})[a]||[],function(a,b){return c.push(b.handler)}),b.unbind(a),b.bind(a,d.trigger),$.fn[a]=$.fn[a]||d.bind,$.event.special[a]=$.event.special[a]||{setup:d.setup,teardown:d.teardown,add:d.add,remove:d.remove},$.each(c,function(c,d){return b.bind(a,d)});return b},(g=(c=$.fn).outerHtml)!=null?g:c.outerHtml=function(){var a,b,c;a=$(this),b=a.get(0),c=b.outerHTML||(new XMLSerializer).serializeToString(b);return c},(h=(d=$.fn).mercury)!=null?h:d.mercury=function(a){var b;b=$(this),a&&b.data("type",a);return b.each(function(){return window.mercuryInstance.buildRegion($(this))})}}.call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};this.Mercury.Editor=function(){function b(a,b){this.saveUrl=a!=null?a:null,this.options=b!=null?b:{}}b.prototype.initializeInterface=function(){},b.prototype.initializeEditor=function(){},b.prototype.initializeRegions=function(){var a,b,c,d,e;jQuery(".mercury-region",this.document).mercury(),d=this.regions,e=[];for(b=0,c=d.length;b<c;b++){a=d[b];if(a.focus){a.focus();break}}return e},b.prototype.buildRegion=function(a,b){var c;try{c=(a.data("type")||"rich").titleize();return this.regions.push(new Mercury.Regions[c](a,b))}catch(d){if(Mercury.debug)throw d;return alert('Region type is malformed, no data-type provided, or "'+c+'" is unknown.')}},b.prototype.finalizeInterface=function(){this.snippetToolbar=new Mercury.SnippetToolbar(this.document),this.hijackLinks();return this.resize()},b.prototype.bindEvents=function(){Mercury.bind("initialize:frame",a(function(){return setTimeout(this.initializeFrame,1e3)},this)),Mercury.bind("region:focused",function(){return $("body").removeClass("mercury-hidden")}),Mercury.bind("region:blurred",function(){return $("body").addClass("mercury-hidden")}),Mercury.bind("action",a(function(a,b){if(b.action==="save")return this.save()},this)),this.document.click(function(a){Mercury.trigger("hide:dialogs");if(Mercury.region&&jQuery(a.target).closest(".mercury-region").get(0)!==Mercury.region.element.get(0))return Mercury.trigger("unfocus:regions")}),jQuery(window).resize(a(function(){return this.resize()},this));return window.onbeforeunload=this.beforeUnload},b.prototype.resize=function(){return Mercury.trigger("resize")},b.prototype.hijackLinks=function(){var a,b,c,d,e,f,g,h,i,j;h=jQuery("a",this.document),j=[];for(d=0,f=h.length;d<f;d++){c=h[d],b=!1,i=this.options.ignoredLinks||[];for(e=0,g=i.length;e<g;e++){a=i[e];if(jQuery(c).hasClass(a)){b=!0;continue}}j.push(!b&&(c.target===""||c.target==="_self")&&!jQuery(c).closest(".mercury-region").length?jQuery(c).attr("target","_top"):void 0)}return j},b.prototype.beforeUnload=function(){return Mercury.changes&&!Mercury.silent?"You have unsaved changes.\tAre you sure you want to leave without saving them first?":null},b.prototype.save=function(b){var c;c=this.serialize(),Mercury.log("saving",c),this.options.saveStyle!=="form"&&(c=jQuery.toJSON(c));return jQuery.ajax(b,{type:"POST",data:{content:c},success:a(function(){return Mercury.changes=!1},this),error:a(function(){return alert("Mercury was unable to save to the url: "+b)},this)})},b.prototype.serialize=function(){var a,b,c,d,e;b={},e=this.regions;for(c=0,d=e.length;c<d;c++)a=e[c],b[a.name]=a.serialize();return b};return b}()}.call(this),function(){var a=Object.prototype.hasOwnProperty,b=function(b,c){function e(){this.constructor=b}for(var d in c)a.call(c,d)&&(b[d]=c[d]);e.prototype=c.prototype,b.prototype=new e,b.__super__=c.prototype;return b},c=function(a,b){return function(){return a.apply(b,arguments)}};this.Mercury.IframeEditor=function(){function a(b,c){var d;this.saveUrl=b!=null?b:null,this.options=c!=null?c:{},a.__super__.constructor.apply(this,arguments);if(!Mercury.supported)throw"Mercury.PageEditor is unsupported in this client. Supported browsers are chrome 10+, firefix 4+, and safari 5+.";if(window.mercuryInstance)throw"Mercury.PageEditor can only be instantiated once.";window.mercuryInstance=this,this.regions=[],this.initializeInterface();if(d=jQuery('meta[name="csrf-token"]').attr("content"))Mercury.csrfToken=d;$(function(){return $("body").createPromiseEvent("mercury-ready").trigger("mercury-ready")})}b(a,this.Mercury.Editor),a.prototype.initializeInterface=function(){var b,d;a.__super__.initializeInterface.apply(this,arguments),document.body.innerHTML="&nbsp;",this.focusableElement=jQuery("<input>",{type:"text",style:"position:absolute;opacity:0"}).appendTo((b=this.options.appendTo)!=null?b:"body"),this.iframe=jQuery("<iframe>",{"class":"mercury-iframe",seamless:"true",frameborder:"0",src:"about:blank"}),this.iframe.appendTo((d=jQuery(this.options.appendTo).get(0))!=null?d:"body"),this.iframe.load(c(function(){return this.initializeEditor()},this));return this.iframe.get(0).contentWindow.document.location.href=this.iframeSrc()},a.prototype.initializeEditor=function(){var b;a.__super__.initializeEditor.apply(this,arguments),this.toolbar=new Mercury.Toolbar(this.options),this.statusbar=new Mercury.Statusbar(this.options);try{if(this.iframe.data("loaded"))return;this.iframe.data("loaded",!0),this.document=jQuery(this.iframe.get(0).contentWindow.document),jQuery('<style mercury-styles="true">').html(Mercury.config.injectedStyles).appendTo(this.document.find("head")),$("body").addClass("mercury-iframe"),b=this.iframe.get(0).contentWindow,jQuery.globalEval=function(a){if(a&&/\S/.test(a))return(b.execScript||function(a){return b.eval.call(b,a)})(a)},b.Mercury=Mercury,this.bindEvents(),this.initializeRegions();return this.finalizeInterface()}catch(c){return alert("Mercury.PageEditor failed to load: "+c+"\n\nPlease try refreshing.")}},a.prototype.buildRegion=function(b){return a.__super__.buildRegion.call(this,b,this.iframe.get(0).contentWindow)},a.prototype.bindEvents=function(){a.__super__.bindEvents.apply(this,arguments),Mercury.bind("focus:frame",c(function(){return this.iframe.focus()},this));return Mercury.bind("focus:window",c(function(){return setTimeout(c(function(){return this.focusableElement.focus()},this),10)},this))},a.prototype.resize=function(){var b,c,d;d=jQuery(window).width(),b=this.statusbar.top(),c=this.toolbar.height(),Mercury.displayRect={top:c,left:0,width:d,height:b-c,fullHeight:b},this.iframe.css({top:Mercury.displayRect.top,left:0,height:Mercury.displayRect.height});return a.__super__.resize.apply(this,arguments)},a.prototype.iframeSrc=function(a){a==null&&(a=null);return(a!=null?a:window.location.href).replace(/([http|https]:\/\/.[^\/]*)\/editor\/?(.*)/i,"$1/$2")},a.prototype.save=function(){var b,c;b=(c=this.saveUrl)!=null?c:this.iframeSrc();return a.__super__.save.call(this,b)};return a}.call(this)}.call(this),function(){var a=Object.prototype.hasOwnProperty,b=function(b,c){function e(){this.constructor=b}for(var d in c)a.call(c,d)&&(b[d]=c[d]);e.prototype=c.prototype,b.prototype=new e,b.__super__=c.prototype;return b};this.Mercury.InlineEditor=function(){function a(b,c){var d;this.saveUrl=b!=null?b:null,this.options=c!=null?c:{},a.__super__.constructor.apply(this,arguments);if(!Mercury.supported)throw"Mercury.PageEditor is unsupported in this client. Supported browsers are chrome 10+, firefix 4+, and safari 5+.";if(window.mercuryInstance)throw"Mercury.PageEditor can only be instantiated once.";window.mercuryInstance=this,this.regions=[],this.initializeInterface();if(d=$('meta[name="csrf-token"]').attr("content"))Mercury.csrfToken=d;$(function(){return $("body").createPromiseEvent("mercury-ready").trigger("mercury-ready")})}b(a,this.Mercury.Editor),a.prototype.initializeInterface=function(){a.__super__.initializeInterface.apply(this,arguments);return this.initializeEditor()},a.prototype.initializeEditor=function(){a.__super__.initializeEditor.apply(this,arguments),this.document=$(document),this.toolbar=new Mercury.Toolbar(this.options),this.statusbar=new Mercury.Statusbar(this.options),$("body").addClass("mercury-inline").addClass("mercury-hidden"),$('<style mercury-styles="true">').html(Mercury.config.injectedStyles).appendTo(this.document.find("head")),this.bindEvents(),this.initializeRegions();return this.finalizeInterface()},a.prototype.buildRegion=function(b){return a.__super__.buildRegion.call(this,b,window)},a.prototype.bindEvents=function(){a.__super__.bindEvents.apply(this,arguments),Mercury.bind("region:focused",function(){var a;a=$("body"),a.removeClass("mercury-hidden");return Mercury.region.element.offset().top<=window.mercuryInstance.toolbar.height()?a.css({position:"absolute",top:window.mercuryInstance.toolbar.height()}):a.css({position:"static",top:0})});return Mercury.bind("region:blurred",function(){var a;a=$("body");return a.addClass("mercury-hidden").css({position:"static",top:0})})},a.prototype.save=function(){var b;return a.__super__.save.call(this,(b=this.saveUrl)!=null?b:document.location.href)},a.prototype.resize=function(){var b,c;c=jQuery(window).width(),b=jQuery(window).height(),Mercury.displayRect={top:0,left:0,width:c,height:b,fullHeight:b};return a.__super__.resize.apply(this,arguments)};return a}.call(this)}.call(this),function(){this.Mercury.HistoryBuffer=function(){function a(a){this.maxLength=a!=null?a:200,this.index=0,this.stack=[],this.markerRegExp=/<em class="mercury-marker"><\/em>/g}a.prototype.push=function(a){if(jQuery.type(a)==="string"){if(this.stack[this.index]&&this.stack[this.index].replace(this.markerRegExp,"")===a.replace(this.markerRegExp,""))return}else if(jQuery.type(a)==="object"&&a.html&&this.stack[this.index]&&this.stack[this.index].html===a.html)return;this.stack=this.stack.slice(0,this.index+1),this.stack.push(a),this.stack.length>this.maxLength&&this.stack.shift();return this.index=this.stack.length-1},a.prototype.undo=function(){if(this.index<1)return null;this.index-=1;return this.stack[this.index]},a.prototype.redo=function(){if(this.index>=this.stack.length-1)return null;this.index+=1;return this.stack[this.index]};return a}()}.call(this),function(){this.Mercury.tableEditor=function(a,b,c){Mercury.tableEditor.load(a,b,c);return Mercury.tableEditor},jQuery.extend(Mercury.tableEditor,{load:function(a,b,c){this.table=a,this.cell=b,this.cellContent=c!=null?c:"",this.row=this.cell.parent("tr"),this.columnCount=this.getColumnCount();return this.rowCount=this.getRowCount()},addColumn:function(a){var b,c,d,e,f,g,h,i,j,k,l;a==null&&(a="after"),i=this.cellSignatureFor(this.cell),k=this.table.find("tr"),l=[];for(b=0,j=k.length;b<j;b++)g=k[b],h=1,d=a==="after"?{right:i.right}:{left:i.left},l.push((e=this.findCellByOptionsFor(g,d))?(f=jQuery("<"+e.cell.get(0).tagName+">").html(this.cellContent),this.setRowspanFor(f,e.height),a==="before"?e.cell.before(f):e.cell.after(f),b+=e.height-1):(c=this.findCellByIntersectionFor(g,i))?this.setColspanFor(c.cell,c.width+1):void 0);return l},removeColumn:function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o;h=this.cellSignatureFor(this.cell);if(!(h.width>1)){f=[],a=[],n=this.table.find("tr");for(c=0,k=n.length;c<k;c++)g=n[c],(e=this.findCellByOptionsFor(g,{left:h.left,width:h.width}))?(f.push(e.cell),c+=e.height-1):(d=this.findCellByIntersectionFor(g,h))&&a.push(d.cell);for(i=0,l=f.length;i<l;i++)b=f[i],jQuery(b).remove();o=[];for(j=0,m=a.length;j<m;j++)b=a[j],o.push(this.setColspanFor(b,this.colspanFor(b)-1));return o}},addRow:function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r;a==null&&(a="after"),f=jQuery("<tr>"),(i=this.rowspanFor(this.cell))>1&&a==="after"&&(this.row=jQuery(this.row.nextAll("tr")[i-2])),c=0,p=this.row.find("th, td");for(j=0,m=p.length;j<m;j++){b=p[j],d=this.colspanFor(b),e=jQuery("<"+b.tagName+">").html(this.cellContent),this.setColspanFor(e,d),c+=d;if((i=this.rowspanFor(b))>1&&a==="after"){this.setRowspanFor(b,i+1);continue}f.append(e)}if(c<this.columnCount){h=0,q=this.row.prevAll("tr");for(k=0,n=q.length;k<n;k++){g=q[k],h+=1,r=jQuery(g).find("td[rowspan], th[rowspan]");for(l=0,o=r.length;l<o;l++)b=r[l],i=this.rowspanFor(b),i-1>=h&&a==="before"?this.setRowspanFor(b,i+1):i-1>=h&&a==="after"&&(i-1===h?(e=jQuery("<"+b.tagName+">").html(this.cellContent),this.setColspanFor(e,this.colspanFor(b)),f.append(e)):this.setRowspanFor(b,i+1))}}return a==="before"?this.row.before(f):this.row.after(f)},removeRow:function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w;i=!0,f=0,e=0,s=this.row.find("td, th");for(k=0,o=s.length;k<o;k++){b=s[k],h=this.rowspanFor(b),f&&h!==f&&(i=!1);if(h<e||!e)e=h;f=h}if(!(!i&&this.rowspanFor(this.cell)>e)){if(e>1)for(c=0,t=e-2;0<=t?c<=t:c>=t;0<=t?c++:c--)jQuery(this.row.nextAll("tr")[c]).remove();u=this.row.find("td[rowspan], th[rowspan]");for(l=0,p=u.length;l<p;l++){b=u[l],j=this.cellSignatureFor(b);if(j.height===e)continue;if(d=this.findCellByOptionsFor(this.row.nextAll("tr")[e-1],{left:j.left,forceAdjacent:!0}))this.setRowspanFor(b,this.rowspanFor(b)-this.rowspanFor(this.cell)),d.direction==="before"?d.cell.before(jQuery(b).clone()):d.cell.after(jQuery(b).clone())}if(this.columnsFor(this.row.find("td, th"))<this.columnCount){g=0,v=this.row.prevAll("tr");for(m=0,q=v.length;m<q;m++){a=v[m],g+=1,w=jQuery(a).find("td[rowspan], th[rowspan]");for(n=0,r=w.length;n<r;n++)b=w[n],h=this.rowspanFor(b),h>g&&this.setRowspanFor(b,h-this.rowspanFor(this.cell))}}return this.row.remove()}},increaseColspan:function(){var a;a=this.cell.next("td, th");if(!!a.length){if(this.rowspanFor(a)!==this.rowspanFor(this.cell))return;if(this.cellIndexFor(a)>this.cellIndexFor(this.cell)+this.colspanFor(this.cell))return;this.setColspanFor(this.cell,this.colspanFor(this.cell)+this.colspanFor(a));return a.remove()}},decreaseColspan:function(){var a;if(this.colspanFor(this.cell)!==1){this.setColspanFor(this.cell,this.colspanFor(this.cell)-1),a=jQuery("<"+this.cell.get(0).tagName+">").html(this.cellContent),this.setRowspanFor(a,this.rowspanFor(this.cell));return this.cell.after(a)}},increaseRowspan:function(){var a,b,c;c=this.cellSignatureFor(this.cell),b=this.row.nextAll("tr")[c.height-1];if(b&&(a=this.findCellByOptionsFor(b,{left:c.left,width:c.width}))){this.setRowspanFor(this.cell,c.height+a.height);return a.cell.remove()}},decreaseRowspan:function(){var a,b,c,d;d=this.cellSignatureFor(this.cell);if(d.height!==1){c=this.row.nextAll("tr")[d.height-2];if(a=this.findCellByOptionsFor(c,{left:d.left,forceAdjacent:!0})){b=jQuery("<"+this.cell.get(0).tagName+">").html(this.cellContent),this.setColspanFor(b,this.colspanFor(this.cell)),this.setRowspanFor(this.cell,d.height-1);return a.direction==="before"?a.cell.before(b):a.cell.after(b)}}},getColumnCount:function(){return this.columnsFor(this.table.find("thead tr:first-child, tbody tr:first-child, tfoot tr:first-child").first().find("td, th"))},getRowCount:function(){return this.table.find("tr").length},cellIndexFor:function(a){var b,c,d,e,f,g,h,i,j,k,l,m;a=jQuery(a),f=a.parent("tr"),d=this.columnsFor(f.find("td, th")),e=this.columnsFor(a.prevAll("td, th"));if(d<this.columnCount){g=0,l=f.prevAll("tr");for(h=0,j=l.length;h<j;h++){c=l[h],g+=1,m=jQuery(c).find("td[rowspan], th[rowspan]");for(i=0,k=m.length;i<k;i++)b=m[i],this.rowspanFor(b)>g&&this.cellIndexFor(b)<=e&&(e+=this.colspanFor(b))}}return e},cellSignatureFor:function(a){var b;b={cell:jQuery(a)},b.left=this.cellIndexFor(a),b.width=this.colspanFor(a),b.height=this.rowspanFor(a),b.right=b.left+b.width;return b},findCellByOptionsFor:function(a,b){var c,d,e,f,g,h;h=jQuery(a).find("td, th");for(f=0,g=h.length;f<g;f++){c=h[f],e=this.cellSignatureFor(c);if(typeof b.right!="undefined"&&e.right===b.right)return e;if(typeof b.left!="undefined")if(b.width){if(e.left===b.left&&e.width===b.width)return e}else if(!b.forceAdjacent){if(e.left===b.left)return e}else if(b.forceAdjacent&&e.left>b.left){d=jQuery(c).prev("td, th"),d.length?(e=this.cellSignatureFor(d),e.direction="after"):e.direction="before";return e}}if(b.forceAdjacent){e.direction="after";return e}return null},findCellByIntersectionFor:function(a,b){var c,d,e,f,g;g=jQuery(a).find("td, th");for(e=0,f=g.length;e<f;e++){c=g[e],d=this.cellSignatureFor(c);if(d.right-b.left>=0&&d.right>b.left)return d}return null},columnsFor:function(a){var b,c,d,e;c=0;for(d=0,e=a.length;d<e;d++)b=a[d],c+=this.colspanFor(b);return c},colspanFor:function(a){return parseInt(jQuery(a).attr("colspan"))||1},rowspanFor:function(a){return parseInt(jQuery(a).attr("rowspan"))||1},setColspanFor:function(a,b){return jQuery(a).attr("colspan",b>1?b:null)},setRowspanFor:function(a,b){return jQuery(a).attr("rowspan",b>1?b:null)}})}.call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};this.Mercury.Dialog=function(){function b(a,b,c){this.url=a,this.name=b,this.options=c!=null?c:{},this.button=this.options["for"],this.build(),this.bindEvents(),this.preload()}b.prototype.build=function(){var a;this.element=jQuery("<div>",{"class":"mercury-dialog mercury-"+this.name+"-dialog loading",style:"display:none"});return this.element.appendTo((a=jQuery(this.options.appendTo).get(0))!=null?a:"body")},b.prototype.bindEvents=function(){return this.element.mousedown(function(a){return a.stopPropagation()})},b.prototype.preload=function(){if(this.options.preload)return this.load()},b.prototype.toggle=function(a){return this.visible?this.hide():this.show()},b.prototype.resize=function(){return this.show()},b.prototype.show=function(){Mercury.trigger("hide:dialogs",this),this.visible=!0;if(this.loaded){this.element.css({width:"auto",height:"auto"}),this.position(this.visible);return this.appear()}this.position();return this.appear()},b.prototype.position=function(a){},b.prototype.appear=function(){this.element.css({display:"block",opacity:0});return this.element.animate({opacity:.95},200,"easeInOutSine",a(function(){if(!this.loaded)return this.load(a(function(){return this.resize()},this))},this))},b.prototype.hide=function(){this.element.hide();return this.visible=!1},b.prototype.load=function(b){if(!!this.url){if(!Mercury.preloadedViews[this.url])return jQuery.ajax(this.url,{success:a(function(a){this.loadContent(a),Mercury.dialogHandlers[this.name]&&Mercury.dialogHandlers[this.name].call(this);if(b)return b()},this),error:a(function(){this.hide(),this.button&&this.button.removeClass("pressed");return alert("Mercury was unable to load "+this.url+" for the "+this.name+" dialog.")},this)});this.loadContent(Mercury.preloadedViews[this.url]),Mercury.dialogHandlers[this.name]&&Mercury.dialogHandlers[this.name].call(this);if(b)return b()}},b.prototype.loadContent=function(a){this.loaded=!0,this.element.removeClass("loading");return this.element.html(a)};return b}()}.call(this),function(){var a=Object.prototype.hasOwnProperty,b=function(b,c){function e(){this.constructor=b}for(var d in c)a.call(c,d)&&(b[d]=c[d]);e.prototype=c.prototype,b.prototype=new e,b.__super__=c.prototype;return b},c=function(a,b){return function(){return a.apply(b,arguments)}};this.Mercury.Palette=function(){function a(b,c,d){this.url=b,this.name=c,this.options=d!=null?d:{},a.__super__.constructor.apply(this,arguments)}b(a,Mercury.Dialog),a.prototype.build=function(){var a;this.element=jQuery("<div>",{"class":"mercury-palette mercury-"+this.name+"-palette loading",style:"display:none"});return this.element.appendTo((a=jQuery(this.options.appendTo).get(0))!=null?a:"body")},a.prototype.bindEvents=function(){Mercury.bind("hide:dialogs",c(function(a,b){if(b!==this)return this.hide()},this));return a.__super__.bindEvents.apply(this,arguments)},a.prototype.position=function(a){var b,c;this.element.css({top:0,left:0,display:"block",visibility:"hidden"}),b=this.button.offset(),c=this.element.width(),b.left+c>jQuery(window).width()&&(b.left=b.left-c+this.button.width());return this.element.css({top:b.top+this.button.height(),left:b.left,display:a?"block":"none",visibility:"visible"})};return a}()}.call(this),function(){var a=Object.prototype.hasOwnProperty,b=function(b,c){function e(){this.constructor=b}for(var d in c)a.call(c,d)&&(b[d]=c[d]);e.prototype=c.prototype,b.prototype=new e,b.__super__=c.prototype;return b},c=function(a,b){return function(){return a.apply(b,arguments)}};this.Mercury.Select=function(){function a(b,c,d){this.url=b,this.name=c,this.options=d!=null?d:{},a.__super__.constructor.apply(this,arguments)}b(a,Mercury.Dialog),a.prototype.build=function(){var a;this.element=jQuery("<div>",{"class":"mercury-select mercury-"+this.name+"-select loading",style:"display:none"});return this.element.appendTo((a=jQuery(this.options.appendTo).get(0))!=null?a:"body")},a.prototype.bindEvents=function(){Mercury.bind("hide:dialogs",c(function(a,b){if(b!==this)return this.hide()},this)),this.element.mousedown(c(function(a){return a.preventDefault()},this));return a.__super__.bindEvents.apply(this,arguments)},a.prototype.position=function(a){var b,c,d,e,f,g,h;this.element.css({top:0,left:0,display:"block",visibility:"hidden"}),g=this.button.offset(),d=this.element.width(),c=this.element.height(),b=jQuery(document).height(),Mercury.displayRect.height===Mercury.displayRect.fullHeight?h=g.top+this.button.height()-jQuery(document).scrollTop():(h=g.top+this.button.height()/2-c/2,h<g.top-100&&(h=g.top-100),h<20&&(h=20)),e=this.loaded?"auto":c,h+c>=b-20&&(e=b-h-20),f=g.left,f+d>jQuery(window).width()&&(f=f-d+this.button.width());return this.element.css({top:h,left:f,height:e,display:a?"block":"none",visibility:"visible"})};return a}()}.call(this),function(){var a=Object.prototype.hasOwnProperty,b=function(b,c){function e(){this.constructor=b}for(var d in c)a.call(c,d)&&(b[d]=c[d]);e.prototype=c.prototype,b.prototype=new e,b.__super__=c.prototype;return b},c=function(a,b){return function(){return a.apply(b,arguments)}};this.Mercury.Panel=function(){function a(b,c,d){this.url=b,this.name=c,this.options=d!=null?d:{},a.__super__.constructor.apply(this,arguments)}b(a,Mercury.Dialog),a.prototype.build=function(){var a;this.element=jQuery("<div>",{"class":"mercury-panel loading",style:"display:none;"}),this.titleElement=jQuery("<h1>"+this.options.title+"</h1>").appendTo(this.element),this.paneElement=jQuery("<div>",{"class":"mercury-panel-pane"}).appendTo(this.element);return this.element.appendTo((a=jQuery(this.options.appendTo).get(0))!=null?a:"body")},a.prototype.bindEvents=function(){Mercury.bind("resize",c(function(){return this.position(this.visible)},this)),Mercury.bind("hide:panels",c(function(a,b){if(b!==this){this.button.removeClass("pressed");return this.hide()}},this)),this.element.mousedown(function(a){return a.stopPropagation()});return a.__super__.bindEvents.apply(this,arguments)},a.prototype.show=function(){Mercury.trigger("hide:panels",this);return a.__super__.show.apply(this,arguments)},a.prototype.resize=function(){var a,b,d;this.paneElement.css({display:"none"}),d=this.element.width(),this.paneElement.css({visibility:"hidden",width:"auto",display:"block"}),b=this.element.width(),this.paneElement.css({visibility:"visible",display:"none"}),a=this.element.offset(),this.element.animate({left:a.left-(b-d),width:b},200,"easeInOutSine",c(function(){this.paneElement.css({display:"block",width:b});return this.makeDraggable()},this));if(!this.visible)return this.hide()},a.prototype.position=function(a){var b,c,d,e,f;this.element.css({display:"block",visibility:"hidden"}),e=this.element.offset(),b=this.element.width(),c=Mercury.displayRect.height-16,f=c-this.titleElement.outerHeight(),this.paneElement.css({height:f,overflowY:f<30?"hidden":"auto"}),this.moved||(d=Mercury.displayRect.width-b-20),d<=8&&(d=8);if(this.pinned||b+e.left>Mercury.displayRect.width-20)d=Mercury.displayRect.width-b-20;this.element.css({top:Mercury.displayRect.top+8,left:d,height:c,display:a?"block":"none",visibility:"visible"}),this.makeDraggable();if(!a)return this.element.hide()},a.prototype.loadContent=function(a){this.loaded=!0,this.element.removeClass("loading"),this.paneElement.css({visibility:"hidden"});return this.paneElement.html(a)},a.prototype.makeDraggable=function(){var a;a=this.element.width();return this.element.draggable({handle:"h1",axis:"x",opacity:.7,scroll:!1,addClasses:!1,iframeFix:!0,containment:[8,0,Mercury.displayRect.width-a-20,0],stop:c(function(){var b;b=this.element.offset().left,this.moved=!0,this.pinned=b>Mercury.displayRect.width-a-30?!0:!1;return!0},this)})};return a}()}.call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};this.Mercury.modal=function(a,b){b==null&&(b={}),Mercury.modal.show(a,b);return Mercury.modal},jQuery.extend(Mercury.modal,{minWidth:400,show:function(a,b){this.url=a,this.options=b!=null?b:{},Mercury.trigger("focus:window"),this.initialize();return this.visible?this.update():this.appear()},initialize:function(){if(!this.initialized){this.build(),this.bindEvents();return this.initialized=!0}},build:function(){var a,b;this.element=jQuery("<div>",{"class":"mercury-modal loading"}),this.element.html('<h1 class="mercury-modal-title"><span></span><a>&times;</a></h1>'),this.element.append('<div class="mercury-modal-content-container"><div class="mercury-modal-content"></div></div>'),this.overlay=jQuery("<div>",{"class":"mercury-modal-overlay"}),this.titleElement=this.element.find(".mercury-modal-title"),this.contentContainerElement=this.element.find(".mercury-modal-content-container"),this.contentElement=this.element.find(".mercury-modal-content"),this.element.appendTo((a=jQuery(this.options.appendTo).get(0))!=null?a:"body"),this.overlay.appendTo((b=jQuery(this.options.appendTo).get(0))!=null?b:"body");return this.titleElement.find("span").html(this.options.title)},bindEvents:function(){Mercury.bind("refresh",a(function(){return this.resize(!0)},this)),Mercury.bind("resize",a(function(){return this.position()},this)),this.overlay.click(a(function(){return this.hide()},this));return this.titleElement.find("a").click(a(function(){return this.hide()},this))},appear:function(){this.position(),this.overlay.show();return this.overlay.animate({opacity:1},200,"easeInOutSine",a(function(){this.element.css({top:-this.element.height()}),this.setTitle(),this.element.show();return this.element.animate({top:0},200,"easeInOutSine",a(function(){this.visible=!0;return this.load()},this))},this))},resize:function(b){var c,d,e,f;e=b?"visible":"hidden",d=this.titleElement.outerHeight(),f=this.contentElement.outerWidth(),this.contentPane&&this.contentPane.css({height:"auto"}),this.contentElement.css({height:"auto",visibility:e,display:"block"}),c=this.contentElement.outerHeight()+d,f<this.minWidth&&(f=this.minWidth);if(c>Mercury.displayRect.fullHeight-20||this.options.fullHeight)c=Mercury.displayRect.fullHeight-20;return this.element.stop().animate({left:(Mercury.displayRect.width-f)/2,width:f,height:c},200,"easeInOutSine",a(function(){var a;this.contentElement.css({visibility:"visible",display:"block"});if(this.contentPane.length){this.contentElement.css({height:c-d,overflow:"visible"}),a=this.contentControl.length?this.contentControl.outerHeight():0,this.contentPane.css({height:c-d-a-40});return this.contentPane.find(".mercury-modal-pane").css({width:f-40})}return this.contentElement.css({height:c-d,overflow:"auto"})},this))},position:function(){var a,b,c,d,e;d=Mercury.displayRect.width,this.contentPane&&this.contentPane.css({height:"auto"}),this.contentElement.css({height:"auto"}),this.element.css({width:"auto",height:"auto",display:"block",visibility:"hidden"}),e=this.element.width(),b=this.element.height(),e<this.minWidth&&(e=this.minWidth);if(b>Mercury.displayRect.fullHeight-20||this.options.fullHeight)b=Mercury.displayRect.fullHeight-20;c=this.titleElement.outerHeight(),this.contentPane&&this.contentPane.length?(this.contentElement.css({height:b-c,overflow:"visible"}),a=this.contentControl.length?this.contentControl.outerHeight():0,this.contentPane.css({height:b-c-a-40}),this.contentPane.find(".mercury-modal-pane").css({width:e-40})):this.contentElement.css({height:b-c,overflow:"auto"});return this.element.css({left:(d-e)/2,width:e,height:b,display:this.visible?"block":"none",visibility:"visible"})},update:function(){this.reset(),this.resize();return this.load()},load:function(){this.element.addClass("loading"),this.setTitle();return Mercury.preloadedViews[this.url]?setTimeout(a(function(){return this.loadContent(Mercury.preloadedViews[this.url])},this),10):jQuery.ajax(this.url,{type:this.options.loadType||"get",data:this.options.loadData,success:a(function(a){return this.loadContent(a)},this),error:a(function(){this.hide();return alert("Mercury was unable to load "+this.url+" for the modal.")},this)})},loadContent:function(a,b){b==null&&(b=null),this.initialize(),this.options=b||this.options,this.setTitle(),this.loaded=!0,this.element.removeClass("loading"),this.contentElement.html(a),this.contentElement.css({display:"none",visibility:"hidden"}),this.contentPane=this.element.find(".mercury-modal-pane-container"),this.contentControl=this.element.find(".mercury-modal-controls"),this.options.afterLoad&&this.options.afterLoad.call(this),this.options.handler&&Mercury.modalHandlers[this.options.handler]&&Mercury.modalHandlers[this.options.handler].call(this);return this.resize()},setTitle:function(){return this.titleElement.find("span").html(this.options.title)},reset:function(){this.titleElement.find("span").html("");return this.contentElement.html("")},hide:function(){Mercury.trigger("focus:frame"),this.element.hide(),this.overlay.hide(),this.reset();return this.visible=!1}})}.call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};this.Mercury.Statusbar=function(){function b(a){this.options=a!=null?a:{},this.build(),this.bindEvents()}b.prototype.build=function(){var a;return this.element=jQuery("<div>",{"class":"mercury-statusbar"}).appendTo((a=jQuery(this.options.appendTo).get(0))!=null?a:"body")},b.prototype.bindEvents=function(){return Mercury.bind("region:update",a(function(a,b){if(b.region&&jQuery.type(b.region.path)==="function")return this.setPath(b.region.path())},this))},b.prototype.height=function(){return this.element.outerHeight()},b.prototype.top=function(){return this.element.offset().top},b.prototype.setPath=function(a){var b,c,d,e;c=[];for(d=0,e=a.length;d<e;d++)b=a[d],c.push("<a>"+b.tagName.toLowerCase()+"</a>");return this.element.html("<span><strong>Path: </strong></span>"+c.reverse().join(" &raquo; "))};return b}()}.call(this),function(){var a=Object.prototype.hasOwnProperty,b=function(a,b){return function(){return a.apply(b,arguments)}};this.Mercury.Toolbar=function(){function c(a){this.options=a!=null?a:{},this.build(),this.bindEvents()}c.prototype.build=function(){var b,c,d,e,f,g,h,i,j,k;this.element=jQuery("<div>",{"class":"mercury-toolbar-container",style:"width:10000px"}),this.element.appendTo((j=jQuery(this.options.appendTo).get(0))!=null?j:"body"),k=Mercury.config.toolbars;for(i in k){if(!a.call(k,i))continue;d=k[i];if(d._custom)continue;h=jQuery("<div>",{"class":"mercury-toolbar mercury-"+i+"-toolbar"}).appendTo(this.element),d._regions&&h.attr("data-regions",d._regions),e=jQuery("<div>",{"class":"mercury-toolbar-button-container"}).appendTo(h);for(c in d){if(!a.call(d,c))continue;g=d[c];if(c==="_regions")continue;b=this.buildButton(c,g),b&&b.appendTo(e)}e.css("white-space")==="nowrap"&&(f=new Mercury.Toolbar.Expander(i,{appendTo:h,"for":e}),f.appendTo(this.element)),i!=="primary"&&h.addClass("disabled")}return this.element.css({width:"100%"})},c.prototype.buildButton=function(b,c){var d,e,f,g,h,i,j;if(b[0]==="_"||!c)return!1;switch(jQuery.type(c)){case"array":j=c[0],i=c[1],g=c[2];return new Mercury.Toolbar.Button(b,j,i,g,{appendDialogsTo:this.element});case"object":f=new Mercury.Toolbar.ButtonGroup(b,c);for(d in c){if(!a.call(c,d))continue;h=c[d],e=this.buildButton(d,h),e&&e.appendTo(f)}return f;case"string":return jQuery("<hr>",{"class":"mercury-"+(c==="-"?"line-separator":"separator")});default:throw"Unknown button structure -- please provide an array, object, or string for "+b+"."}},c.prototype.bindEvents=function(){Mercury.bind("region:focused",b(function(a,b){var c,d,e,f,g,h;g=this.element.find(".mercury-toolbar"),h=[];for(e=0,f=g.length;e<f;e++)d=g[e],d=jQuery(d),h.push((c=d.data("regions"))?c.split(",").indexOf(b.region.type)>-1?d.removeClass("disabled"):void 0:void 0);return h},this)),Mercury.bind("region:blurred",b(function(a,b){var c,d,e,f,g,h;g=this.element.find(".mercury-toolbar"),h=[];for(e=0,f=g.length;e<f;e++)d=g[e],d=jQuery(d),h.push((c=d.data("regions"))?c.split(",").indexOf(b.region.type)>-1?d.addClass("disabled"):void 0:void 0);return h},this)),this.element.click(function(){return Mercury.trigger("hide:dialogs")});return this.element.mousedown(function(a){return a.preventDefault()})},c.prototype.height=function(){return this.element.outerHeight()};return c}()}.call(this),function(){var a=Object.prototype.hasOwnProperty,b=function(a,b){return function(){return a.apply(b,arguments)}};this.Mercury.Toolbar.Button=function(){function c(a,b,c,d,e){this.name=a,this.title=b,this.summary=c!=null?c:null,this.types=d!=null?d:{},this.options=e!=null?e:{},this.build(),this.bindEvents();return this.element}c.prototype.build=function(){var b,c,d,e,f,g,h;this.element=jQuery("<div>",{title:(f=this.summary)!=null?f:this.title,"class":"mercury-button mercury-"+this.name+"-button"}).html("<em>"+this.title+"</em>"),this.element.data("expander",'<div class="mercury-expander-button" data-button="'+this.name+'"><em></em><span>'+this.title+"</span></div>"),this.handled=[],b={title:this.summary||this.title,preload:this.types.preload,appendTo:this.options.appendDialogsTo||"body","for":this.element},g=this.types,h=[];for(d in g){if(!a.call(g,d))continue;c=g[d],h.push(function(){switch(d){case"preload":return!0;case"regions":this.element.addClass("disabled");return this.handled[d]=jQuery.isFunction(c)?c.call(this,this.name):c;case"toggle":return this.handled[d]=!0;case"mode":return this.handled[d]=c===!0?this.name:c;case"context":return this.handled[d]=jQuery.isFunction(c)?c:Mercury.Toolbar.Button.contexts[this.name];case"palette":this.element.addClass("mercury-button-palette"),e=jQuery.isFunction(c)?c.call(this,this.name):c;return this.handled[d]=new Mercury.Palette(e,this.name,b);case"select":this.element.addClass("mercury-button-select").find("em").html(this.title),e=jQuery.isFunction(c)?c.call(this,this.name):c;return this.handled[d]=new Mercury.Select(e,this.name,b);case"panel":this.element.addClass("mercury-button-panel"),e=jQuery.isFunction(c)?c.call(this,this.name):c,this.handled.toggle=!0;return this.handled[d]=new Mercury.Panel(e,this.name,b);case"modal":return this.handled[d]=jQuery.isFunction(c)?c.apply(this,this.name):c;default:throw"Unknown button type "+d+" used for the "+this.name+" button."}}.call(this))}return h},c.prototype.bindEvents=function(){Mercury.bind("button",b(function(a,b){if(b.action===this.name)return this.element.click()},this)),Mercury.bind("region:update",b(function(a,b){var c;if(this.handled.context&&b.region&&jQuery.type(b.region.currentElement)==="function"){c=b.region.currentElement();return c.length&&this.handled.context.call(this,c,b.region.element)?this.element.addClass("active"):this.element.removeClass("active")}return this.element.removeClass("active")},this)),Mercury.bind("region:focused",b(function(a,b){if(this.handled.regions&&b.region&&b.region.type)return this.handled.regions.indexOf(b.region.type)>-1?this.element.removeClass("disabled"):this.element.addClass("disabled")},this)),Mercury.bind("region:blurred",b(function(a,b){if(this.handled.regions)return this.element.addClass("disabled")},this)),this.element.mousedown(b(function(a){return this.element.addClass("active")},this)),this.element.mouseup(b(function(a){return this.element.removeClass("active")},this));return this.element.click(b(function(b){var c,d,e,f;if(!this.element.closest(".disabled").length){c=!1,f=this.handled;for(e in f){if(!a.call(f,e))continue;d=f[e];switch(e){case"toggle":this.togglePressed();break;case"mode":c=!0,Mercury.trigger("mode",{mode:d});break;case"modal":c=!0,Mercury.modal(this.handled.modal,{title:this.summary||this.title,handler:this.name});break;case"palette":case"select":case"panel":b.stopPropagation(),c=!0,this.handled[e].toggle()}}c||Mercury.trigger("action",{action:this.name});return Mercury.trigger("focus:frame")}},this))},c.prototype.togglePressed=function(){return this.element.toggleClass("pressed")};return c}(),this.Mercury.Toolbar.Button.contexts={backColor:function(a){return this.element.css("background-color",a.css("background-color"))},foreColor:function(a){return this.element.css("background-color",a.css("color"))},bold:function(a){var b;b=a.css("font-weight");return b==="bold"||b>400},italic:function(a){return a.css("font-style")==="italic"},overline:function(a){return a.css("text-decoration")==="overline"||a.parent().css("text-decoration")==="overline"},strikethrough:function(a,b){return a.css("text-decoration")==="line-through"||!!a.closest("strike",b).length},underline:function(a,b){return a.css("text-decoration")==="underline"||!!a.closest("u",b).length},subscript:function(a,b){return!!a.closest("sub",b).length},superscript:function(a,b){return!!a.closest("sup",b).length},justifyLeft:function(a){return a.css("text-align").indexOf("left")>-1},justifyCenter:function(a){return a.css("text-align").indexOf("center")>-1},justifyRight:function(a){return a.css("text-align").indexOf("right")>-1},justifyFull:function(a){return a.css("text-align").indexOf("justify")>-1},insertOrderedList:function(a,b){return!!a.closest("ol",b.element).length},insertUnorderedList:function(a,b){return!!a.closest("ul",b.element).length}}}.call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};this.Mercury.Toolbar.ButtonGroup=function(){function b(a,b){this.name=a,this.options=b!=null?b:{},this.build(),this.bindEvents(),this.regions=this.options._regions;return this.element}b.prototype.build=function(){this.element=jQuery("<div>",{"class":"mercury-button-group mercury-"+this.name+"-group"});if(this.options._context||this.options._regions)return this.element.addClass("disabled")},b.prototype.bindEvents=function(){Mercury.bind("region:update",a(function(a,b){var c,d;c=Mercury.Toolbar.ButtonGroup.contexts[this.name];if(c&&b.region&&jQuery.type(b.region.currentElement)==="function"){d=b.region.currentElement();return d.length&&c.call(this,d,b.region.element)?this.element.removeClass("disabled"):this.element.addClass("disabled")}},this)),Mercury.bind("region:focused",a(function(a,b){if(this.regions&&b.region&&b.region.type){if(!(this.regions.indexOf(b.region.type)>-1))return this.element.addClass("disabled");if(!this.options._context)return this.element.removeClass("disabled")}},this));return Mercury.bind("region:blurred",a(function(a,b){if(this.options.regions)return this.element.addClass("disabled")},this))};return b}(),this.Mercury.Toolbar.ButtonGroup.contexts={table:function(a,b){return!!a.closest("table",b).length}}}.call(this),function(){var a=Object.prototype.hasOwnProperty,b=function(b,c){function e(){this.constructor=b}for(var d in c)a.call(c,d)&&(b[d]=c[d]);e.prototype=c.prototype,b.prototype=new e,b.__super__=c.prototype;return b},c=function(a,b){return function(){return a.apply(b,arguments)}};this.Mercury.Toolbar.Expander=function(){function a(b,c){this.name=b,this.options=c,this.container=this.options["for"],this.containerWidth=this.container.outerWidth(),a.__super__.constructor.call(this,null,this.name,this.options);return this.element}b(a,Mercury.Palette),a.prototype.build=function(){var a;this.container.css({whiteSpace:"normal"}),this.trigger=jQuery("<div>",{"class":"mercury-toolbar-expander"}).appendTo((a=jQuery(this.options.appendTo).get(0))!=null?a:"body"),this.element=jQuery("<div>",{"class":"mercury-palette mercury-expander mercury-"+this.name+"-expander",style:"display:none"});return this.windowResize()},a.prototype.bindEvents=function(){Mercury.bind("hide:dialogs",c(function(a,b){if(b!==this)return this.hide()},this)),Mercury.bind("resize",c(function(){return this.windowResize()},this)),a.__super__.bindEvents.apply(this,arguments),this.trigger.click(c(function(a){var b,c,d,e,f;a.stopPropagation(),c=[],f=this.container.find(".mercury-button");for(d=0,e=f.length;d<e;d++)b=f[d],b=jQuery(b),b.position().top>5&&c.push(b.data("expander"));this.loadContent(c.join(""));return this.toggle()},this));return this.element.click(c(function(a){var b,c;c=jQuery(a.target).closest("[data-button]").data("button"),b=this.container.find(".mercury-"+c+"-button");return b.click()},this))},a.prototype.windowResize=function(){this.containerWidth>jQuery(window).width()?this.trigger.show():this.trigger.hide();return this.hide()},a.prototype.position=function(a){var b,c;this.element.css({top:0,left:0,display:"block",visibility:"hidden"}),b=this.trigger.offset(),c=this.element.width(),b.left+c>jQuery(window).width()&&(b.left=b.left-c+this.trigger.width());return this.element.css({top:b.top+this.trigger.height(),left:b.left,display:a?"block":"none",visibility:"visible"})};return a}()}.call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};this.Mercury.tooltip=function(a,b,c){c==null&&(c={}),Mercury.tooltip.show(a,b,c);return Mercury.tooltip},jQuery.extend(Mercury.tooltip,{show:function(a,b,c){this.forElement=a,this.content=b,this.options=c!=null?c:{},this.document=jQuery(this.forElement.get(0).ownerDocument),this.initialize();return this.visible?this.update():this.appear()},initialize:function(){if(!this.initialized){this.build(),this.bindEvents();return this.initialized=!0}},build:function(){var a;this.element=jQuery("<div>",{"class":"mercury-tooltip"});return this.element.appendTo((a=jQuery(this.options.appendTo).get(0))!=null?a:"body")},bindEvents:function(){Mercury.bind("resize",a(function(){if(this.visible)return this.position()},this)),this.document.scroll(a(function(){if(this.visible)return this.position()},this));return this.element.mousedown(function(a){a.preventDefault();return a.stopPropagation()})},appear:function(){this.update(),this.element.show();return this.element.animate({opacity:1},200,"easeInOutSine",a(function(){return this.visible=!0},this))},update:function(){this.element.html(this.content);return this.position()},position:function(){var a,b,c,d;b=this.forElement.offset(),d=this.element.width(),c=b.top+this.forElement.outerHeight(),a=b.left-jQuery(this.document).scrollLeft(),Mercury.displayRect.height!==Mercury.displayRect.fullHeight&&(c+=Mercury.displayRect.top-jQuery(this.document).scrollTop()),a+d+25>Mercury.displayRect.width&&(a=a-(a+d+25)-Mercury.displayRect.width),a=a<=0?0:a;return this.element.css({top:c,left:a})},hide:function(){if(!!this.initialized){this.element.hide();return this.visible=!1}}})}.call(this),function(){var a=Object.prototype.hasOwnProperty,b=function(a,b){return function(){return a.apply(b,arguments)}};this.Mercury.Snippet=function(){function c(a,b,c){this.name=a,this.identity=b,c==null&&(c={}),this.version=0,this.data="",this.history=new Mercury.HistoryBuffer,this.setOptions(c)}c.all=[],c.displayOptionsFor=function(a){Mercury.modal(Mercury.config.snippets.optionsUrl.replace(":name",a),{title:"Snippet Options",handler:"insertSnippet",snippetName:a});return Mercury.snippet=null},c.create=function(a,b){var c,d;c="snippet_"+this.all.length,d=new Mercury.Snippet(a,c,b),this.all.push(d);return d},c.find=function(a){var b,c,d,e;e=this.all;for(c=0,d=e.length;c<d;c++){b=e[c];if(b.identity===a)return b}return null},c.load=function(b){var c,d,e,f;f=[];for(d in b){if(!a.call(b,d))continue;c=b[d],e=new Mercury.Snippet(c.name,d,c.options),f.push(this.all.push(e))}return f},c.prototype.getHTML=function(a,b){var c;b==null&&(b=null),c=jQuery('<div class="mercury-snippet" contenteditable="false">',a),c.attr({"data-snippet":this.identity}),c.attr({"data-version":this.version}),c.html("["+this.identity+"]"),this.loadPreview(c,b);return c},c.prototype.getText=function(a){return"[--"+this.identity+"--]"},c.prototype.loadPreview=function(a,c){c==null&&(c=null);return jQuery.ajax(Mercury.config.snippets.previewUrl.replace(":name",this.name),{type:"POST",data:this.options,success:b(function(b){this.data=b,a.html(b);if(c)return c()},this),error:b(function(){return alert("Error loading the preview for the "+this.name+" snippet.")},this)})},c.prototype.displayOptions=function(){Mercury.snippet=this;return Mercury.modal(Mercury.config.snippets.optionsUrl.replace(":name",this.name),{title:"Snippet Options",handler:"insertSnippet",loadType:"post",loadData:this.options})},c.prototype.setOptions=function(a){this.options=a,delete this.options.authenticity_token,delete this.options.utf8,this.version+=1;return this.history.push(this.options)},c.prototype.setVersion=function(a){a==null&&(a=null),a=parseInt(a);if(a&&this.history.stack[a-1]){this.version=a-1,this.options=this.history.stack[this.version];return!0}return!1},c.prototype.serialize=function(){return{name:this.name,options:this.options}};return c}()}.call(this),function(){var a=Object.prototype.hasOwnProperty,b=function(b,c){function e(){this.constructor=b}for(var d in c)a.call(c,d)&&(b[d]=c[d]);e.prototype=c.prototype,b.prototype=new e,b.__super__=c.prototype;return b},c=function(a,b){return function(){return a.apply(b,arguments)}};this.Mercury.SnippetToolbar=function(){function d(a,b){this.document=a,this.options=b!=null?b:{},d.__super__.constructor.call(this,this.options)}b(d,Mercury.Toolbar),d.prototype.build=function(){var b,c,d,e,f,g;this.element=jQuery("<div>",{"class":"mercury-toolbar mercury-snippet-toolbar",style:"display:none"}),this.element.appendTo((e=jQuery(this.options.appendTo).get(0))!=null?e:"body"),f=Mercury.config.toolbars.snippetable,g=[];for(c in f){if(!a.call(f,c))continue;d=f[c],b=this.buildButton(c,d),g.push(b?b.appendTo(this.element):void 0)}return g},d.prototype.bindEvents=function(){Mercury.bind("show:toolbar",c(function(a,b){if(!!b.snippet){b.snippet.mouseout(c(function(){return this.hide()},this));return this.show(b.snippet)}},this)),Mercury.bind("hide:toolbar",c(function(a,b){if(!!b.type&&b.type==="snippet")return this.hide(b.immediately)},this)),jQuery(this.document).scroll(c(function(){if(this.visible)return this.position()},this)),this.element.mousemove(c(function(){return clearTimeout(this.hideTimeout)},this));return this.element.mouseout(c(function(){return this.hide()},this))},d.prototype.show=function(a){this.snippet=a,Mercury.tooltip.hide(),this.position();return this.appear()},d.prototype.position=function(){var a,b,c;b=this.snippet.offset(),c=b.top+Mercury.displayRect.top-jQuery(this.document).scrollTop()-this.height()+10,a=b.left-jQuery(this.document).scrollLeft();return this.element.css({top:c,left:a})},d.prototype.appear=function(){clearTimeout(this.hideTimeout);if(!this.visible){this.visible=!0,this.element.css({display:"block",opacity:0});return this.element.stop().animate({opacity:1},200,"easeInOutSine")}},d.prototype.hide=function(a){a==null&&(a=!1),clearTimeout(this.hideTimeout);if(a){this.element.hide();return this.visible=!1}return this.hideTimeout=setTimeout(c(function(){this.element.stop().animate({opacity:0},300,"easeInOutSine",c(function(){return this.element.hide()},this));return this.visible=!1},this),500)};return d}()}.call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};this.Mercury.Region=function(){function c(a,b,c){this.element=a,this.window=b,this.options=c!=null?c:{},this.type||(this.type="region"),Mercury.log("building "+this.type,this.element,this.options),this.document=this.window.document,this.name=this.element.attr("id"),this.history=new Mercury.HistoryBuffer,this.build(),this.bindEvents(),this.pushHistory()}var b;b="region",c.prototype.build=function(){},c.prototype.focus=function(){},c.prototype.bindEvents=function(){Mercury.bind("mode",a(function(a,b){if(b.mode==="preview")return this.togglePreview()},this)),Mercury.bind("focus:frame",a(function(){if(!this.previewing){if(Mercury.region!==this)return;return this.focus()}},this)),Mercury.bind("action",a(function(a,b){if(!this.previewing){if(Mercury.region!==this)return;if(b.action)return this.execCommand(b.action,b)}},this)),this.element.mousemove(a(function(a){var b;if(!this.previewing){if(Mercury.region!==this)return;b=jQuery(a.target).closest(".mercury-snippet");if(b.length){this.snippet=b;return Mercury.trigger("show:toolbar",{type:"snippet",snippet:this.snippet})}}},this));return this.element.mouseout(a(function(a){if(!this.previewing)return Mercury.trigger("hide:toolbar",{type:"snippet",immediately:!1})},this))},c.prototype.content=function(a,b){var c,d,e,f,g;a==null&&(a=null),b==null&&(b=!1);if(a!==null)return this.element.html(a);c=jQuery("<div>").appendTo(this.document.createDocumentFragment()),c.html(this.element.html().replace(/^\s+|\s+$/g,""));if(b){g=c.find(".mercury-snippet");for(d=0,f=g.length;d<f;d++)e=g[d],e=jQuery(e),e.attr({contenteditable:null,"data-version":null}),e.html("["+e.data("snippet")+"]")}return c.html()},c.prototype.togglePreview=function(){if(!this.previewing){this.previewing=!0,this.element.addClass("mercury-region-preview").removeClass("mercury-region");return Mercury.trigger("region:blurred",{region:this})}this.previewing=!1,this.element.addClass("mercury-region").removeClass("mercury-region-preview");if(Mercury.region===this)return this.focus()},c.prototype.execCommand=function(a,b){b==null&&(b={}),this.focus(),a!=="redo"&&this.pushHistory(),Mercury.log("execCommand",a,b.value);return Mercury.changes=!0},c.prototype.pushHistory=function(){return this.history.push(this.content())},c.prototype.snippets=function(){var a,b,c,d,e,f;c={},f=this.element.find("[data-snippet]");for(d=0,e=f.length;d<e;d++)a=f[d],b=Mercury.Snippet.find(jQuery(a).data("snippet")),b.setVersion(jQuery(a).data("version")),c[b.identity]=b.serialize();return c},c.prototype.serialize=function(){return{type:this.type,value:this.content(null,!0),snippets:this.snippets()}};return c}()}.call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}},b=Object.prototype.hasOwnProperty;this.Mercury.uploader=function(a,b){Mercury.config.uploading.enabled&&Mercury.uploader.show(a,b);return Mercury.uploader},jQuery.extend(Mercury.uploader,{show:function(b,c){this.options=c!=null?c:{},this.file=new Mercury.uploader.File(b);if(this.file.errors)alert("Error: "+this.file.errors);else{if(!this.supported())return;Mercury.trigger("focus:window");if(Mercury.config.uploading.enabled==="local")return this.file.readAsDataURL(a(function(a){return Mercury.trigger("action",{action:"insertImage",value:{src:a}})},this));if(Mercury.config.uploading.enabled){this.initialize();return this.appear()}}},initialize:function(){if(!this.initialized){this.build(),this.bindEvents();return this.initialized=!0}},supported:function(){var a,b;b=new XMLHttpRequest,a=window.FileReader,window.Uint8Array&&window.ArrayBuffer&&!XMLHttpRequest.prototype.sendAsBinary&&(XMLHttpRequest.prototype.sendAsBinary=function(a){var b,c,d,e;d=new Uint8Array(a.length);for(c=0,e=a.length;c<e;c++)b=a[c],d[c]=a.charCodeAt(c)&255;return this.send(d.buffer)});return!!(b.upload&&b.sendAsBinary&&a)},build:function(){var a,b;this.element=jQuery("<div>",{"class":"mercury-uploader",style:"display:none"}),this.element.append('<div class="mercury-uploader-preview"><b><img/></b></div>'),this.element.append('<div class="mercury-uploader-details"></div>'),this.element.append('<div class="mercury-uploader-progress"><span>Processing...</span><div class="mercury-uploader-indicator"><div><b>0%</b></div></div></div>'),this.overlay=jQuery("<div>",{"class":"mercury-uploader-overlay",style:"display:none"}),this.element.appendTo((a=jQuery(this.options.appendTo).get(0))!=null?a:"body");return this.overlay.appendTo((b=jQuery(this.options.appendTo).get(0))!=null?b:"body")},bindEvents:function(){return Mercury.bind("resize",a(function(){return this.position()},this))},appear:function(){this.fillDisplay(),this.position(),this.overlay.show();return this.overlay.animate({opacity:1},200,"easeInOutSine",a(function(){this.element.show();return this.element.animate({opacity:1},200,"easeInOutSine",a(function(){this.visible=!0;return this.loadImage()},this))},this))},position:function(){var a,b;b=this.element.outerWidth(),a=this.element.outerHeight();return this.element.css({top:(Mercury.displayRect.height-a)/2,left:(Mercury.displayRect.width-b)/2})},fillDisplay:function(){var a;a=["Name: "+this.file.name,"Size: "+this.file.readableSize,"Type: "+this.file.type];return this.element.find(".mercury-uploader-details").html(a.join("<br/>"))},loadImage:function(){return this.file.readAsDataURL(a(function(a){this.element.find(".mercury-uploader-preview b").html(jQuery("<img>",{src:a}));return this.upload()},this))},upload:function(){var b;b=new XMLHttpRequest,jQuery.each(["onloadstart","onprogress","onload","onabort","onerror"],a(function(c,d){return b.upload[d]=a(function(a){return this.uploaderEvents[d].call(this,a)},this)},this)),b.onload=a(function(a){var b;try{b=Mercury.config.uploading.handler?Mercury.config.uploading.handler(a.target.responseText):jQuery.parseJSON(a.target.responseText);return Mercury.trigger("action",{action:"insertImage",value:{src:b.image.url}})}catch(c){return this.updateStatus("Unable to process response:<br/>"+c.toString())}},this),b.open("post",Mercury.config.uploading.url,!0),b.setRequestHeader("Accept","application/json, text/javascript, text/html, application/xml, text/xml, */*"),b.setRequestHeader("X-Requested-With","XMLHttpRequest"),b.setRequestHeader("X-CSRF-Token",Mercury.csrfToken);return this.file.readAsBinaryString(a(function(a){var c;c=new Mercury.uploader.MultiPartPost(Mercury.config.uploading.inputName,this.file,a),this.file.updateSize(c.delta),b.setRequestHeader("Content-Type","multipart/form-data; boundary="+c.boundary);return b.sendAsBinary(c.body)},this))},updateStatus:function(a,b){var c;this.element.find(".mercury-uploader-progress span").html(a);if(b){c=Math.floor(b*100/this.file.size)+"%",this.element.find(".mercury-uploader-indicator div").css({width:c});return this.element.find(".mercury-uploader-indicator b").html(c).show()}},hide:function(b){b==null&&(b=0);return setTimeout(a(function(){return this.element.animate({opacity:0},200,"easeInOutSine",a(function(){return this.overlay.animate({opacity:0},200,"easeInOutSine",a(function(){this.overlay.hide(),this.element.hide(),this.reset(),this.visible=!1;return Mercury.trigger("focus:frame")},this))},this))},this),b*1e3)},reset:function(){this.element.find(".mercury-uploader-preview b").html(""),this.element.find(".mercury-uploader-indicator div").css({width:0}),this.element.find(".mercury-uploader-indicator b").html("0%").hide();return this.updateStatus("Processing...")},uploaderEvents:{onloadstart:function(){return this.updateStatus("Uploading...")},onprogress:function(a){return this.updateStatus("Uploading...",a.loaded)},onabort:function(){this.updateStatus("Aborted");return this.hide(1)},onload:function(){this.updateStatus("Successfully uploaded",this.file.size);return this.hide(1)},onerror:function(){this.updateStatus("Error: Unable to upload the file");return this.hide(5)}}}),Mercury.uploader.File=function(){function b(a){var b;this.file=a,this.size=this.file.size,this.fullSize=this.file.size,this.readableSize=this.file.size.toBytes(),this.name=this.file.fileName,this.type=this.file.type,b=[],this.size>=Mercury.config.uploading.maxFileSize&&b.push("Too large"),Mercury.config.uploading.allowedMimeTypes.indexOf(this.type)>-1||b.push("Unsupported format"),b.length&&(this.errors=b.join(" / "))}b.prototype.readAsDataURL=function(b){var c;b==null&&(b=null),c=new FileReader,c.readAsDataURL(this.file);return c.onload=a(function(){if(b)return b(c.result)},this)},b.prototype.readAsBinaryString=function(b){var c;b==null&&(b=null),c=new FileReader,c.readAsBinaryString(this.file);return c.onload=a(function(){if(b)return b(c.result)},this)},b.prototype.updateSize=function(a){return this.fullSize=this.size+a};return b}(),Mercury.uploader.MultiPartPost=function(){function a(a,b,c,d){this.inputName=a,this.file=b,this.contents=c,this.formInputs=d!=null?d:{},this.boundary="Boundaryx20072377098235644401115438165x",this.body="",this.buildBody(),this.delta=this.body.length-this.file.size}a.prototype.buildBody=function(){var a,c,d,e;a="--"+this.boundary,e=this.formInputs;for(c in e){if(!b.call(e,c))continue;d=e[c],this.body+=""+a+'\r\nContent-Disposition: form-data; name="'+c+'"\r\n\r\n'+unescape(encodeURIComponent(d))+"\r\n"}return this.body+=""+a+'\r\nContent-Disposition: form-data; name="'+this.inputName+'"; filename="'+this.file.name+'"\r\nContent-Type: '+this.file.type+"\r\nContent-Transfer-Encoding: binary\r\n\r\n"+this.contents+"\r\n"+a+"--"};return a}()}.call(this),function(){var a=Object.prototype.hasOwnProperty,b=function(b,c){function e(){this.constructor=b}for(var d in c)a.call(c,d)&&(b[d]=c[d]);e.prototype=c.prototype,b.prototype=new e,b.__super__=c.prototype;return b},c=function(a,b){return function(){return a.apply(b,arguments)}};this.Mercury.Regions.Basic=function(){function d(a,b,c){this.element=a,this.window=b,this.options=c!=null?c:{},d.__super__.constructor.apply(this,arguments),this.type="basic"}var a;b(d,Mercury.Region),a="basic",d.prototype.build=function(){var a,b,c,d;jQuery.browser.mozilla&&this.content()===""&&this.content("&nbsp;"),this.element.data({originalOverflow:this.element.css("overflow")}),this.element.css({overflow:"auto"}),this.specialContainer=jQuery.browser.mozilla&&this.element.get(0).tagName!=="DIV",this.element.get(0).contentEditable=!0,d=this.element.find(".mercury-snippet");for(b=0,c=d.length;b<c;b++)a=d[b],a.contentEditable=!1,jQuery(a).attr("data-version","1");if(!this.document.mercuryEditing){this.document.execCommand("styleWithCSS",!1,!1),this.document.execCommand("insertBROnReturn",!1,!1),this.document.execCommand("enableInlineTableEditing",!1,!1),this.document.execCommand("enableObjectResizing",!1,!1);return this.document.mercuryEditing=!0}},d.prototype.bindEvents=function(){d.__super__.bindEvents.apply(this,arguments),Mercury.bind("region:update",c(function(){var a,b,d;if(!this.previewing){if(Mercury.region!==this)return;setTimeout(c(function(){return this.selection().forceSelection(this.element.get(0))},this),1),b=this.currentElement();if(b.length){d=b.closest("table",this.element),d.length&&Mercury.tableEditor(d,b.closest("tr, td"),"&nbsp;"),a=b.closest("a",this.element);return a.length&&a.attr("href")?Mercury.tooltip(a,'<a href="'+a.attr("href")+'" target="_blank">'+a.attr("href")+"</a>",{position:"below"}):Mercury.tooltip.hide()}}},this)),this.element.bind("paste",c(function(){var a;if(!this.previewing){if(Mercury.region!==this)return;Mercury.changes=!0;if(this.specialContainer){event.preventDefault();return}a=this.content(),clearTimeout(this.handlePasteTimeout);return this.handlePasteTimeout=setTimeout(c(function(){return this.handlePaste(a)},this),100)}},this)),this.element.focus(c(function(){if(!this.previewing){Mercury.region=this,setTimeout(c(function(){return this.selection().forceSelection(this.element.get(0))},this),1);return Mercury.trigger("region:focused",{region:this})}},this)),this.element.blur(c(function(){if(!this.previewing){Mercury.trigger("region:blurred",{region:this});return Mercury.tooltip.hide()}},this)),this.element.click(c(function(a){if(this.previewing)return jQuery(a.target).closest("a").attr("target","_top")},this)),this.element.dblclick(c(function(a){var b;if(!this.previewing){b=jQuery(a.target).closest("img",this.element);if(b.length){this.selection().selectNode(b.get(0),!0);return Mercury.trigger("button",{action:"insertMedia"})}}},this)),this.element.mouseup(c(function(){if(!this.previewing){this.pushHistory();return Mercury.trigger("region:update",{region:this})}},this)),this.element.keydown(c(function(a){var b,c;if(!this.previewing){Mercury.changes=!0;switch(a.keyCode){case 90:if(!a.metaKey)return;a.preventDefault(),a.shiftKey?this.execCommand("redo"):this.execCommand("undo");return;case 13:a.preventDefault();return!1;case 9:a.preventDefault(),b=this.selection().commonAncestor(),c=!1,b.closest("li",this.element).length&&(c=!0,a.shiftKey?this.execCommand("outdent"):this.execCommand("indent")),c||this.execCommand("insertHTML",{value:"&nbsp; "})}if(a.metaKey)switch(a.keyCode){case 66:this.execCommand("bold"),a.preventDefault();break;case 73:this.execCommand("italic"),a.preventDefault();break;case 85:this.execCommand("underline"),a.preventDefault()}return this.pushHistory(a.keyCode)}},this));return this.element.keyup(c(function(){if(!this.previewing)return Mercury.trigger("region:update",{region:this})},this))},d.prototype.focus=function(){var a;Mercury.region!==this&&(this.element.focus(),a=this.selection().selection,a.type!=="None"&&(a=this.selection().selection.collapseToStart())),Mercury.trigger("region:focused",{region:this});return Mercury.trigger("region:update",{region:this})},d.prototype.content=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o;a==null&&(a=null),b==null&&(b=!0),c==null&&(c=!1);if(a!==null){d=jQuery("<div>").appendTo(this.document.createDocumentFragment()),d.html(a),n=d.find("[data-snippet]");for(k=0,l=n.length;k<l;k++){f=n[k],f.contentEditable=!1,f=jQuery(f);if(i=Mercury.Snippet.find(f.data("snippet")))if(!f.data("version"))try{j=parseInt(f.html().match(/\/(\d+)\]/)[1]),j&&(i.setVersion(j),f.attr({"data-version":j}),f.html(i.data))}catch(p){}}this.element.html(d.html());return this.selection().selectMarker(this.element)}this.element.find("meta").remove(),c&&(h=this.selection(),h.placeMarker()),d=jQuery("<div>").appendTo(this.document.createDocumentFragment()),d.html(this.element.html().replace(/^\s+|\s+$/g,""));if(b){o=d.find("[data-snippet]");for(g=0,m=o.length;g<m;g++){f=o[g],f=jQuery(f);if(i=Mercury.Snippet.find(f.data("snippet")))i.data=f.html();f.html("["+f.data("snippet")+"/"+f.data("version")+"]"),f.attr({contentEditable:null,"data-version":null})}}e=d.html(),c&&h.removeMarker();return e},d.prototype.togglePreview=function(){this.previewing?(this.element.get(0).contentEditable=!0,this.element.css({overflow:"auto"})):(this.content(this.content()),this.element.get(0).contentEditable=!1,this.element.css({overflow:this.element.data("originalOverflow")}),this.element.blur());return d.__super__.togglePreview.apply(this,arguments)},d.prototype.execCommand=function(a,b){var c,e;b==null&&(b={}),d.__super__.execCommand.apply(this,arguments);switch(a){case"bold":case"italic":case"underline":this.selection().fragment.textContent===""&&!1}if(c=Mercury.config.behaviors[a]||this.actions[a])return c.call(this,this.selection(),b);a==="indent"&&(e=this.element.get(0).previousSibling),a==="insertHTML"&&b.value&&b.value.get&&(b.value=jQuery("<div>").html(b.value).html());try{return this.document.execCommand(a,!1,b.value)}catch(f){if(a==="indent"&&this.element.prev()!==e)return this.element.prev().remove()}},d.prototype.pushHistory=function(a){var b,d,e;b=[13,46,8],e=2.5,a&&(d=b.indexOf(a)),clearTimeout(this.historyTimeout),d>=0&&d!==this.lastKnownKeyCode?this.history.push(this.content(null,!1,!0)):a?this.historyTimeout=setTimeout(c(function(){return this.history.push(this.content(null,!1,!0))},this),e*1e3):this.history.push(this.content(null,!1,!0));return this.lastKnownKeyCode=d},d.prototype.selection=function(){return new this.Selection(this.window.getSelection(),this.document)},d.prototype.path=function(){var a;a=this.selection().commonAncestor();return a?a.get(0)===this.element.get(0)?[]:a.parentsUntil(this.element):[]},d.prototype.currentElement=function(){var a,b;a=[],b=this.selection(),b.range&&(a=b.commonAncestor(),a.get(0).nodeType===3&&(a=a.parent()));return a},d.prototype.handlePaste=function(a){var b,c,d,e;a=a.replace(/^\<br\>/,""),this.element.find(".mercury-region").remove(),d=this.content();if(d.indexOf("<!--StartFragment-->")>-1||d.indexOf('="mso-')>-1||d.indexOf("<o:")>-1||d.indexOf('="Mso')>-1){b=a.singleDiff(this.content()).sanitizeHTML();try{this.document.execCommand("undo",!1,null);return this.execCommand("insertHTML",{value:b})}catch(f){this.content(a);return Mercury.modal("/mercury/modals/sanitizer",{title:"HTML Sanitizer (Starring Clippy)",afterLoad:function(){return this.element.find("textarea").val(b.replace(/<br\/>/g,"\n"))}})}}else if(Mercury.config.cleanStylesOnPaste){e=a.singleDiff(this.content()),c=jQuery("<div>").appendTo(this.document.createDocumentFragment()).html(e),c.find("[style]").attr({style:null}),this.document.execCommand("undo",!1,null);return this.execCommand("insertHTML",{value:c.html()})}},d.prototype.actions={insertRowBefore:function(){return Mercury.tableEditor.addRow("before")},insertRowAfter:function(){return Mercury.tableEditor.addRow("after")},insertColumnBefore:function(){return Mercury.tableEditor.addColumn("before")},insertColumnAfter:function(){return Mercury.tableEditor.addColumn("after")},deleteColumn:function(){return Mercury.tableEditor.removeColumn()},deleteRow:function(){return Mercury.tableEditor.removeRow()},increaseColspan:function(){return Mercury.tableEditor.increaseColspan()},decreaseColspan:function(){return Mercury.tableEditor.decreaseColspan()},increaseRowspan:function(){return Mercury.tableEditor.increaseRowspan()},decreaseRowspan:function(){return Mercury.tableEditor.decreaseRowspan()},undo:function(){return this.content(this.history.undo())},redo:function(){return this.content(this.history.redo())},removeFormatting:function(a){return a.insertTextNode(a.textContent())},backColor:function(a,b){return a.changeStyle("background-color",b.value.toHex())},overline:function(a){return a.toggleStyle("text-decoration","overline")},style:function(a,b){return a.wrap('<span class="'+b.value+'">',!0)},replaceHTML:function(a,b){return this.content(b.value)},insertImage:function(a,b){return this.execCommand("insertHTML",{value:jQuery("<img/>",b.value)})},insertLink:function(a,b){var c;c=jQuery("<"+b.value.tagName+">",this.document).attr(b.value.attrs).html(b.value.content);return a.insertNode(c)},replaceLink:function(a,b){var c,d;c=jQuery("<"+b.value.tagName+">",this.document).attr(b.value.attrs).html(b.value.content),a.selectNode(b.node),d=jQuery("<div>").html(a.content()).find("a").html();return a.replace(jQuery(c,a.context).html(d))},insertSnippet:function(a,b){var c,d;d=b.value,(c=this.element.find("[data-snippet="+d.identity+"]")).length&&a.selectNode(c.get(0));return a.insertNode(d.getHTML(this.document))},editSnippet:function(){var a;if(!!this.snippet){a=Mercury.Snippet.find(this.snippet.data("snippet"));return a.displayOptions()}},removeSnippet:function(){this.snippet&&this.snippet.remove();return Mercury.trigger("hide:toolbar",{type:"snippet",immediately:!0})}},d.prototype.Selection=function(){function a(a,b){this.selection=a,this.context=b;if(this.selection.rangeCount>=1)this.range=this.selection.getRangeAt(0),this.fragment=this.range.cloneContents(),this.clone=this.range.cloneRange();else return}a.prototype.selection=null,a.prototype.context=null,a.prototype.range=null,a.prototype.fragment=null,a.prototype.clone=null,a.prototype.toggleStyle=function(a,b){var c;c="mercury-"+a;if(!this.cleanStyle(c))return this.wrap('<span class="'+c+'" style="'+a+":"+b+'">',!0)},a.prototype.cleanStyle=function(a){var b,c,d;b=this.commonAncestor().parent(),c=b,d=!1,b.is("."+a)&&(c=b.contents(),b.replaceWith(c),d=!0),b.find("."+a).each(function(){var a;a=$(this),a.replaceWith(a.contents());return d=!0});return d},a.prototype.changeStyle=function(a,b){var c;c="mercury-"+a,this.cleanStyle(c);return this.wrap('<span class="'+c+'" style="'+a+":"+b+'">',!0)},a.prototype.commonAncestor=function(a){var b;a==null&&(a=!1);if(!this.range)return null;b=this.range.commonAncestorContainer,b.nodeType===3&&a&&(b=b.parentNode);return jQuery(b)},a.prototype.wrap=function(a,b){b==null&&(b=!1),a=jQuery(a,this.context).html(this.fragment),b&&this.replace(a);return a},a.prototype.textContent=function(){return this.range.cloneContents().textContent},a.prototype.content=function(){return this.range.cloneContents()},a.prototype.is=function(a){var b;b=this.content();return b.childNodes.length===1&&jQuery(b.firstChild).is(a)?jQuery(b.firstChild):!1},a.prototype.forceSelection=function(a){var b,c;if(!!jQuery.browser.webkit){c=this.context.createRange(),this.range?this.commonAncestor(!0).closest(".mercury-snippet").length&&(b=this.context.createTextNode(" "),a.appendChild(b)):a.lastChild&&a.lastChild.nodeType===3&&a.lastChild.textContent.replace(/^[\s+|\n+]|[\s+|\n+]$/,"")===""?(b=a.lastChild,a.lastChild.textContent=" "):(b=this.context.createTextNode(" "),a.appendChild(b));if(b){c.setStartBefore(b),c.setEndBefore(b);return this.selection.addRange(c)}}},a.prototype.selectMarker=function(a){var b,c;b=a.find("em.mercury-marker");if(!!b.length){c=this.context.createRange(),c.setStartBefore(b.get(0)),b.length>=2&&c.setEndBefore(b.get(1)),b.remove(),this.selection.removeAllRanges();return this.selection.addRange(c)}},a.prototype.placeMarker=function(){var a,b;if(!!this.range){this.startMarker=jQuery('<em class="mercury-marker"/>',this.context).get(0),this.endMarker=jQuery('<em class="mercury-marker"/>',this.context).get(0),a=this.range.cloneRange(),a.collapse(!1),a.insertNode(this.endMarker),this.range.collapsed||(b=this.range.cloneRange(),b.collapse(!0),b.insertNode(this.startMarker)),this.selection.removeAllRanges();return this.selection.addRange(this.range)}},a.prototype.removeMarker=function(){jQuery(this.startMarker).remove();return jQuery(this.endMarker).remove()},a.prototype.insertTextNode=function(a){var b;b=this.context.createTextNode(a),this.range.extractContents(),this.range.insertNode(b),this.range.selectNodeContents(b);return this.selection.addRange(this.range)},a.prototype.insertNode=function(a){a.get&&(a=a.get(0)),jQuery.type(a)==="string"&&(a=jQuery(a,this.context).get(0)),this.range.deleteContents(),this.range.insertNode(a),this.range.selectNodeContents(a);return this.selection.addRange(this.range)},a.prototype.selectNode=function(a,b){b==null&&(b=!1),this.range.selectNode(a),b&&this.selection.removeAllRanges();return this.selection.addRange(this.range)},a.prototype.replace=function(a){a.get&&(a=a.get(0)),jQuery.type(a)==="string"&&(a=jQuery(a,this.context).get(0)),this.range.deleteContents(),this.range.insertNode(a),this.range.selectNodeContents(a);return this.selection.addRange(this.range)};return a}();return d}()}.call(this),function(){var a=Object.prototype.hasOwnProperty,b=function(b,c){function e(){this.constructor=b}for(var d in c)a.call(c,d)&&(b[d]=c[d]);e.prototype=c.prototype,b.prototype=new e,b.__super__=c.prototype;return b};this.Mercury.Regions.Plain=function(){function c(a,b,d){this.element=a,this.window=b,this.options=d!=null?d:{},c.__super__.constructor.apply(this,arguments),this.type="plain"}var a;b(c,this.Mercury.Regions.Basic),a="plain",c.prototype.execCommand=function(a,b){var c,d;b==null&&(b={}),console.log(a);if(a!=="redo"&&a!=="undo"&&a!=="insertHTML")return!1;if(c=Mercury.config.behaviors[a]||this.actions[a])return c.call(this,this.selection(),b);a==="indent"&&(d=this.element.get(0).previousSibling),a==="insertHTML"&&b.value&&b.value.get&&(b.value=jQuery("<div>").html(b.value).html());try{return this.document.execCommand(a,!1,b.value)}catch(e){if(a==="indent"&&this.element.prev()!==d)return this.element.prev().remove()}},c.prototype.handlePaste=function(a){var b,c,d;a=a.replace(/^\<br\>/,""),this.element.find(".mercury-region").remove(),c=this.content(),d=a.singleDiff(this.content()),b=jQuery("<div>").appendTo(this.document.createDocumentFragment()).html(d),b.find("[style]").attr({style:null}),this.document.execCommand("undo",!1,null);return this.execCommand("insertHTML",{value:b.text()})},c.prototype.actions={undo:function(){return this.content(this.history.undo())},redo:function(){return this.content(this.history.redo())}};return c}.call(this)}.call(this),function(){var a=Object.prototype.hasOwnProperty,b=function(b,c){function e(){this.constructor=b}for(var d in c)a.call(c,d)&&(b[d]=c[d]);e.prototype=c.prototype,b.prototype=new e,b.__super__=c.prototype;return b},c=function(a,b){return function(){return a.apply(b,arguments)}};this.Mercury.Regions.Rich=function(){function d(a,b,c){this.element=a,this.window=b,this.options=c!=null?c:{},d.__super__.constructor.apply(this,arguments),this.type="rich",this.document.mercuryEditing||(this.document.execCommand("insertBROnReturn",!1,!0),this.document.execCommand("enableObjectResizing",!1,!0))}var a;b(d,Mercury.Regions.Basic),a="rich",d.prototype.bindEvents=function(){d.__super__.bindEvents.apply(this,arguments),this.element.bind("dragenter",c(function(a){a.preventDefault&&a.preventDefault();return a.originalEvent.dataTransfer.dropEffect="copy"},this)),this.element.bind("dragover",c(function(a){a.preventDefault&&a.preventDefault();return a.originalEvent.dataTransfer.dropEffect="copy"},this)),this.element.bind("drop",c(function(a){if(!this.previewing){clearTimeout(this.dropTimeout),this.dropTimeout=setTimeout(c(function(){return this.element.trigger("possible:drop")},this),1);if(!a.originalEvent.dataTransfer.files.length)return;a.preventDefault&&a.preventDefault(),this.focus();return Mercury.uploader(a.originalEvent.dataTransfer.files[0])}},this)),this.element.unbind("keydown").keydown(c(function(a){var b,c;if(!this.previewing){Mercury.changes=!0;switch(a.keyCode){case 90:if(!a.metaKey)return;a.preventDefault(),a.shiftKey?this.execCommand("redo"):this.execCommand("undo");return;case 13:jQuery.browser.webkit&&this.selection().commonAncestor().closest("li, ul",this.element).length===0?(a.preventDefault(),this.document.execCommand("insertLineBreak",!1,null)):this.specialContainer&&(a.preventDefault(),this.document.execCommand("insertHTML",!1,"<br/>"));break;case 9:a.preventDefault(),b=this.selection().commonAncestor(),c=!1,b.closest("li",this.element).length&&(c=!0,a.shiftKey?this.execCommand("outdent"):this.execCommand("indent")),c||this.execCommand("insertHTML",{value:"&nbsp; "})}if(a.metaKey)switch(a.keyCode){case 66:this.execCommand("bold"),a.preventDefault();break;case 73:this.execCommand("italic"),a.preventDefault();break;case 85:this.execCommand("underline"),a.preventDefault()}return this.pushHistory(a.keyCode)}},this));return this.element.keyup(c(function(){if(!this.previewing)return Mercury.trigger("region:update",{region:this})},this))};return d}()}.call(this),function(){var a=Object.prototype.hasOwnProperty,b=function(b,c){function e(){this.constructor=b}for(var d in c)a.call(c,d)&&(b[d]=c[d]);e.prototype=c.prototype,b.prototype=new e,b.__super__=c.prototype;return b},c=function(a,b){return function(){return a.apply(b,arguments)}};this.Mercury.Regions.Markupable=function(){function d(a,b,c){this.element=a,this.window=b,this.options=c!=null?c:{},d.__super__.constructor.apply(this,arguments),this.type="markupable",this.converter=new Showdown.converter}var a;b(d,Mercury.Region),a="markupable",d.prototype.build=function(){var a,b,c;c="100%",a=this.element.height(),b=this.element.html().replace(/^\s+|\s+$/g,"").replace("&gt;",">"),this.textarea=jQuery("<textarea>",this.document).val(b),this.textarea.attr("class",this.element.attr("class")).addClass("mercury-textarea"),this.textarea.css({border:0,background:"transparent",display:"block",width:c,height:a,fontFamily:'"Courier New", Courier, monospace',fontSize:"14px"}),this.element.empty().append(this.textarea),this.element.removeClass("mercury-region"),this.previewElement=jQuery("<div>",this.document),this.element.append(this.previewElement),this.element=this.textarea;return this.resize()},d.prototype.focus=function(){return this.element.focus()},d.prototype.bindEvents=function(){Mercury.bind("mode",c(function(a,b){if(b.mode==="preview")return this.togglePreview()},this)),Mercury.bind("focus:frame",c(function(){if(!this.previewing){if(Mercury.region!==this)return;return this.focus()}},this)),Mercury.bind("action",c(function(a,b){if(!this.previewing){if(Mercury.region!==this)return;if(b.action)return this.execCommand(b.action,b)}},this)),Mercury.bind("unfocus:regions",c(function(a){if(!this.previewing){if(Mercury.region!==this)return;this.element.blur(),this.element.removeClass("focus");return Mercury.trigger("region:blurred",{region:this})}},this)),this.element.bind("dragenter",c(function(a){if(!this.previewing){a.preventDefault();return a.originalEvent.dataTransfer.dropEffect="copy"}},this)),this.element.bind("dragover",c(function(a){if(!this.previewing){a.preventDefault();return a.originalEvent.dataTransfer.dropEffect="copy"}},this)),this.element.bind("drop",c(function(a){if(!this.previewing){Mercury.snippet&&(a.preventDefault(),this.focus(),Mercury.Snippet.displayOptionsFor(Mercury.snippet));if(a.originalEvent.dataTransfer.files.length){a.preventDefault(),this.focus();return Mercury.uploader(a.originalEvent.dataTransfer.files[0])}}},this)),this.element.focus(c(function(){if(!this.previewing){Mercury.region=this,this.element.addClass("focus");return Mercury.trigger("region:focused",{region:this})}},this)),this.element.keydown(c(function(a){var b,c,d,e,f,g;if(!this.previewing){Mercury.changes=!0,this.resize();switch(a.keyCode){case 90:if(!a.metaKey)return;a.preventDefault(),a.shiftKey?this.execCommand("redo"):this.execCommand("undo");return;case 13:e=this.selection(),g=this.element.val(),f=g.lastIndexOf("\n",e.start),b=g.indexOf("\n",e.end),b<f&&(b=g.length),g[f]==="\n"&&(f=g.lastIndexOf("\n",e.start-1)),g[f+1]==="-"&&(e.replace("\n- ",!1,!0),a.preventDefault()),/\d/.test(g[f+1])&&(c=g.substring(f,b),/(\d+)\./.test(c)&&(d=parseInt(RegExp.$1),e.replace("\n"+(d+=1)+". ",!1,!0),a.preventDefault()));break;case 9:a.preventDefault(),this.execCommand("insertHTML",{value:"\t"})}if(a.metaKey)switch(a.keyCode){case 66:this.execCommand("bold"),a.preventDefault();break;case 73:this.execCommand("italic"),a.preventDefault();break;case 85:this.execCommand("underline"),a.preventDefault()}return this.pushHistory(a.keyCode)}},this)),this.element.keyup(c(function(){if(!this.previewing)return Mercury.trigger("region:update",{region:this})},this)),this.element.mouseup(c(function(){if(!this.previewing){this.focus();return Mercury.trigger("region:focused",{region:this})}},this));return this.previewElement.click(c(function(a){if(this.previewing)return $(a.target).closest("a").attr("target","_top")},this))},d.prototype.content=function(a,b){a==null&&(a=null),b==null&&(b=!0);if(a!==null){if(jQuery.type(a)==="string")return this.element.val(a);this.element.val(a.html);return this.selection().select(a.selection.start,a.selection.end)}return this.element.val()},d.prototype.contentAndSelection=function(){return{html:this.content(null,!1),selection:this.selection().serialize()}},d.prototype.togglePreview=function(){var a;this.previewing?(this.previewElement.hide(),this.element.show()):(a=this.converter.makeHtml(this.element.val()),this.previewElement.html(a),this.previewElement.show(),this.element.hide());return d.__super__.togglePreview.apply(this,arguments)},d.prototype.execCommand=function(a,b){var c;b==null&&(b={}),d.__super__.execCommand.apply(this,arguments),(c=Mercury.Regions.Markupable.actions[a])&&c.call(this,this.selection(),b);return this.resize()},d.prototype.pushHistory=function(a){var b,d,e;b=[13,46,8],e=2.5,a&&(d=b.indexOf(a)),clearTimeout(this.historyTimeout),d>=0&&d!==this.lastKnownKeyCode?this.history.push(this.contentAndSelection()):a?this.historyTimeout=setTimeout(c(function(){return this.history.push(this.contentAndSelection())},this),e*1e3):this.history.push(this.contentAndSelection());return this.lastKnownKeyCode=d},d.prototype.selection=function(){return new Mercury.Regions.Markupable.Selection(this.element)},d.prototype.resize=function(){},d.prototype.snippets=function(){},d.actions={undo:function(){return this.content(this.history.undo())},redo:function(){return this.content(this.history.redo())},insertHTML:function(a,b){var c;b.value.get&&(c=b.value.get(0))&&(b.value=jQuery("<div>").html(c).html());return a.replace(b.value,!1,!0)},insertImage:function(a,b){return a.replace("![add alt text]("+encodeURI(b.value.src)+")",!0)},insertLink:function(a,b){return a.replace("["+b.value.content+"]("+b.value.attrs.href+" 'optional title')",!0)},insertUnorderedList:function(a){return a.addList("unordered")},insertOrderedList:function(a){return a.addList("ordered")},style:function(a,b){return a.wrap('<span class="'+b.value+'">',"</span>")},formatblock:function(a,b){var c,d,e;e={h1:["# "," #"],h2:["## "," ##"],h3:["### "," ###"],h4:["#### "," ####"],h5:["##### "," #####"],h6:["###### "," ######"],pre:["\t\t",""],blockquote:["> ",""],p:["\n","\n"]};for(d in e)c=e[d],a.unWrapLine(""+c[0],""+c[1]);if(b.value==="blockquote")Mercury.Regions.Markupable.actions.indent.call(this,a,b);else return a.wrapLine(""+e[b.value][0],""+e[b.value][1])},bold:function(a){return a.wrap("**","**")},italic:function(a){return a.wrap("_","_")},subscript:function(a){return a.wrap("<sub>","</sub>")},superscript:function(a){return a.wrap("<sup>","</sup>")},indent:function(a){return a.wrapLine("> ","",!1,!0)},outdent:function(a){return a.unWrapLine("> ","",!1,!0)},horizontalRule:function(a){return a.replace("\n- - -\n")},insertSnippet:function(a,b){var c;c=b.value;return a.replace(c.getText())}};return d}(),Mercury.Regions.Markupable.Selection=function(){function a(a){this.element=a,this.el=this.element.get(0),this.getDetails()}a.prototype.serialize=function(){return{start:this.start,end:this.end}},a.prototype.getDetails=function(){this.length=this.el.selectionEnd-this.el.selectionStart,this.start=this.el.selectionStart,this.end=this.el.selectionEnd;return this.text=this.element.val().substr(this.start,this.length)},a.prototype.replace=function(a,b,c){var d,e,f;b==null&&(b=!1),c==null&&(c=!1),this.getDetails(),f=this.element.val(),e=this.element.val(),this.element.val(f.substr(0,this.start)+a+f.substr(this.end,f.length)),d=this.element.val()!==e,b&&this.select(this.start,this.start+a.length),c&&this.select(this.start+a.length,this.start+a.length);return d},a.prototype.select=function(a,b){this.start=a,this.end=b,this.element.focus(),this.el.selectionStart=this.start,this.el.selectionEnd=this.end;return this.getDetails()},a.prototype.wrap=function(a,b){this.getDetails(),this.deselectNewLines(),this.replace(a+this.text+b,this.text!=="");if(this.text==="")return this.select(this.start+a.length,this.start+a.length)},a.prototype.wrapLine=function(a,b,c,d){var e,f,g,h;c==null&&(c=!0),d==null&&(d=!1),this.getDetails(),f=this.serialize(),h=this.element.val(),g=h.lastIndexOf("\n",this.start),e=h.indexOf("\n",this.end),e<g&&(e=h.length),h[g]==="\n"&&(g=h.lastIndexOf("\n",this.start-1)),this.select(g+1,e),this.replace(a+this.text+b,c);if(d)return this.select(f.start+a.length,f.end+a.length)},a.prototype.unWrapLine=function(a,b,c,d){var e,f,g,h,i,j,k;c==null&&(c=!0),d==null&&(d=!1),this.getDetails(),i=this.serialize(),k=this.element.val(),j=k.lastIndexOf("\n",this.start),f=k.indexOf("\n",this.end),f<j&&(f=k.length),k[j]==="\n"&&(j=k.lastIndexOf("\n",this.start-1)),this.select(j+1,f),window.something=this.text,g=new RegExp("^"+a.regExpEscape()),h=new RegExp(""+b.regExpEscape()+"$"),e=this.replace(this.text.replace(g,"").replace(h,""),c);if(d&&e)return this.select(i.start-a.length,i.end-a.length)},a.prototype.addList=function(a){var b,c,d,e,f,g;g=this.element.val(),f=g.lastIndexOf("\n",this.start),b=g.indexOf("\n",this.end),b<f&&(b=g.length),g[f]==="\n"&&(f=g.lastIndexOf("\n",this.start-1)),this.select(f+1,b),e=this.text.split("\n");return a==="unordered"?this.replace("- "+e.join("\n- "),!0):this.replace(function(){var a,b;b=[];for(c=0,a=e.length;c<a;c++)d=e[c],b.push(""+(c+1)+". "+d);return b}().join("\n"),!0)},a.prototype.deselectNewLines=function(){var a,b;b=this.text,a=b.replace(/\n+$/g,"").length;return this.select(this.start,this.start+a)},a.prototype.placeMarker=function(){return this.wrap("[mercury-marker]","[mercury-marker]")},a.prototype.removeMarker=function(){var a,b,c;c=this.element.val(),b=c.indexOf("[mercury-marker]");if(b>-1){a=c.indexOf("[mercury-marker]",b+1)-"[mercury-marker]".length,this.element.val(this.element.val().replace(/\[mercury-marker\]/g,""));return this.select(b,a)}return},a.prototype.textContent=function(){return this.text};return a}()}.call(this),function(){var a=Object.prototype.hasOwnProperty,b=function(b,c){function e(){this.constructor=b}for(var d in c)a.call(c,d)&&(b[d]=c[d]);e.prototype=c.prototype,b.prototype=new e,b.__super__=c.prototype;return b},c=function(a,b){return function(){return a.apply(b,arguments)}};this.Mercury.Regions.Snippetable=function(){function d(a,b,c){this.element=a,this.window=b,this.options=c!=null?c:{},d.__super__.constructor.apply(this,arguments),this.type="snippetable",this.makeSortable()}var a;b(d,Mercury.Region),a="snippetable",d.prototype.build=function(){if(this.element.css("minHeight")==="0px")return this.element.css({minHeight:20})},d.prototype.bindEvents=function(){d.__super__.bindEvents.apply(this,arguments),Mercury.bind("unfocus:regions",c(function(a){if(!this.previewing&&Mercury.region===this){this.element.removeClass("focus"),this.element.sortable("destroy");return Mercury.trigger("region:blurred",{region:this})}},this)),Mercury.bind("focus:window",c(function(a){if(!this.previewing&&Mercury.region===this){this.element.removeClass("focus"),this.element.sortable("destroy");return Mercury.trigger("region:blurred",{region:this})}},this)),jQuery(this.document).keydown(c(function(a){if(!this.previewing){if(Mercury.region!==this)return;Mercury.changes=!0;switch(a.keyCode){case 90:if(!a.metaKey)return;a.preventDefault(),a.shiftKey?this.execCommand("redo"):this.execCommand("undo")}}},this)),this.element.mouseup(c(function(){if(!this.previewing){this.focus();return Mercury.trigger("region:focused",{region:this})}},this)),this.element.bind("dragover",c(function(a){if(!this.previewing){a.preventDefault();return a.originalEvent.dataTransfer.dropEffect="copy"}},this));return this.element.bind("drop",c(function(a){if(!this.previewing){if(!Mercury.snippet)return;this.focus(),a.preventDefault();return Mercury.Snippet.displayOptionsFor(Mercury.snippet)}},this))},d.prototype.focus=function(){Mercury.region=this,this.makeSortable();return this.element.addClass("focus")},d.prototype.togglePreview=function(){this.previewing?this.makeSortable():(this.element.sortable("destroy"),this.element.removeClass("focus"));return d.__super__.togglePreview.apply(this,arguments)},d.prototype.execCommand=function(a,b){var c;b==null&&(b={}),d.__super__.execCommand.apply(this,arguments);if(c=Mercury.Regions.Snippetable.actions[a])return c.call(this,b)},d.prototype.makeSortable=function(){return this.element.sortable("destroy").sortable({document:this.document,scroll:!1,containment:"parent",items:".mercury-snippet",opacity:.4,revert:100,tolerance:"pointer",beforeStop:c(function(){Mercury.trigger("hide:toolbar",{type:"snippet",immediately:!0});return!0},this),stop:c(function(){setTimeout(c(function(){return this.pushHistory()},this),100);return!0},this)})},d.actions={undo:function(){return this.content(this.history.undo())},redo:function(){return this.content(this.history.redo())},insertSnippet:function(a){var b,d;d=a.value;return(b=this.element.find("[data-snippet="+d.identity+"]")).length?b.replaceWith(d.getHTML(this.document,c(function(){return this.pushHistory()},this))):this.element.append(d.getHTML(this.document,c(function(){return this.pushHistory()},this)))},editSnippet:function(){var a;if(!!this.snippet){a=Mercury.Snippet.find(this.snippet.data("snippet"));return a.displayOptions()}},removeSnippet:function(){this.snippet&&this.snippet.remove();return Mercury.trigger("hide:toolbar",{type:"snippet",immediately:!0})}};return d}()}.call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};this.Mercury.dialogHandlers.backColor=function(){return this.element.find(".picker, .last-picked").mousedown(a(function(a){var b;b=jQuery(a.target).css("background-color"),this.element.find(".last-picked").css({background:b}),this.button.css({backgroundColor:b});return Mercury.trigger("action",{action:"backColor",value:b})},this))}}.call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};this.Mercury.dialogHandlers.foreColor=function(){return this.element.find(".picker, .last-picked").mousedown(a(function(a){var b;b=jQuery(a.target).css("background-color"),this.element.find(".last-picked").css({background:b}),this.button.css({backgroundColor:b});return Mercury.trigger("action",{action:"foreColor",value:b})},this))}}.call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};this.Mercury.dialogHandlers.formatblock=function(){return this.element.find("[data-tag]").click(a(function(a){var b;b=jQuery(a.target).data("tag");return Mercury.trigger("action",{action:"formatblock",value:b})},this))}}.call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};this.Mercury.dialogHandlers.snippetPanel=function(){this.element.find("input.filter").keyup(a(function(){var a,b,c,d,e,f;b=this.element.find("input.filter").val(),e=this.element.find("li[data-filter]"),f=[];for(c=0,d=e.length;c<d;c++)a=e[c],f.push(LiquidMetal.score(jQuery(a).data("filter"),b)===0?jQuery(a).hide():jQuery(a).show());return f},this));return this.element.find("img[data-snippet]").bind("dragstart",function(a){return Mercury.snippet=jQuery(this).data("snippet")})}}.call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};this.Mercury.dialogHandlers.style=function(){return this.element.find("[data-class]").click(a(function(a){var b;b=jQuery(a.target).data("class");return Mercury.trigger("action",{action:"style",value:b})},this))}}.call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};this.Mercury.modalHandlers.htmlEditor=function(){this.element.find("textarea").val(Mercury.region.content(null,!0,!1));return this.element.find("form").submit(a(function(a){var b;a.preventDefault(),b=this.element.find("textarea").val().replace(/\n/g,""),Mercury.trigger("action",{action:"replaceHTML",value:b});return this.hide()},this))}}.call(this),function(){this.Mercury.modalHandlers.insertCharacter=function(){return this.element.find(".character").click(function(){Mercury.trigger("action",{action:"insertHTML",value:"&"+jQuery(this).attr("data-entity")+";"});return Mercury.modal.hide()})}}.call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};this.Mercury.modalHandlers.insertLink=function(){var b,c,d,e,f,g,h,i,j,k;this.element.find("label input").click(function(a){return jQuery(this).closest("label").next(".selectable").focus()}),this.element.find(".selectable").focus(function(){return jQuery(this).prev("label").find("input[type=radio]").prop("checked",!0)}),this.element.find("#link_target").change(a(function(){this.element.find(".link-target-options").hide(),this.element.find("#"+this.element.find("#link_target").val()+"_options").show();return this.resize(!0)},this)),b=this.element.find("#link_existing_bookmark"),k=jQuery("a[name]",window.mercuryInstance.document);for(i=0,j=k.length;i<j;i++)f=k[i],b.append(jQuery("<option>",{value:jQuery(f).attr("name")}).text(jQuery(f).text()));Mercury.region&&Mercury.region.selection&&(h=Mercury.region.selection(),h&&h.commonAncestor&&(c=h.commonAncestor(!0).closest("a")),c&&c.length&&(d=c,this.element.find("#link_text_container").hide(),c.attr("href")&&c.attr("href").indexOf("#")===0?(b.val(c.attr("href").replace(/[^#]*#/,"")),b.prev("label").find("input[type=radio]").prop("checked",!0)):this.element.find("#link_external_url").val(c.attr("href")),c.attr("name")&&(g=this.element.find("#link_new_bookmark"),g.val(c.attr("name")),g.prev("label").find("input[type=radio]").prop("checked",!0)),c.attr("target")&&this.element.find("#link_target").val(c.attr("target")),c.attr("href")&&c.attr("href").indexOf("javascript:void")===0&&(e=c.attr("href"),this.element.find("#link_external_url").val(e.match(/window.open\('([^']+)',/)[1]),this.element.find("#link_target").val("popup"),this.element.find("#link_popup_width").val(e.match(/width=(\d+),/)[1]),this.element.find("#link_popup_height").val(e.match(/height=(\d+),/)[1]),this.element.find("#popup_options").show())),h.textContent&&this.element.find("#link_text").val(h.textContent()));return this.element.find("form").submit(a(function(a){var b,c,e,f,g,h;a.preventDefault(),e=this.element.find("#link_text").val(),f=this.element.find("#link_target").val(),g=this.element.find("input[name=link_type]:checked").val();switch(g){case"existing_bookmark":c={href:"#"+this.element.find("#link_existing_bookmark").val()};break;case"new_bookmark":c={name:""+this.element.find("#link_new_bookmark").val()};break;default:c={href:this.element.find("#link_"+g).val()}}switch(f){case"popup":b={width:parseInt(this.element.find("#link_popup_width").val())||500,height:parseInt(this.element.find("#link_popup_height").val())||500,menubar:"no",toolbar:"no"},c.href="javascript:void(window.open('"+c.href+"', 'popup_window', '"+jQuery.param(b).replace(/&/g,",")+"'))";break;default:f&&(c.target=f)}h={tagName:"a",attrs:c,content:e},d?Mercury.trigger("action",{action:"replaceLink",value:h,node:d.get(0)}):Mercury.trigger("action",{action:"insertLink",value:h});return this.hide()},this))}}.call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};this.Mercury.modalHandlers.insertMedia=function(){var b,c,d,e;this.element.find("label input").click(function(a){return jQuery(this).closest("label").next(".selectable").focus()}),this.element.find(".selectable").focus(a(function(a){var b;b=jQuery(a.target),b.prev("label").find("input[type=radio]").prop("checked",!0),this.element.find(".media-options").hide(),this.element.find("#"+b.attr("id").replace("media_","")).show();return this.resize(!0)},this)),Mercury.region&&Mercury.region.selection&&(d=Mercury.region.selection(),d.is&&(c=d.is("img"))&&(this.element.find("#media_image_url").val(c.attr("src")),this.element.find("#media_image_alignment").val(c.attr("align"))),d.is&&(b=d.is("iframe"))&&(e=b.attr("src"),e.indexOf("http://www.youtube.com")>-1?(this.element.find("#media_youtube_url").val("http://youtu.be/"+e.match(/\/embed\/(\w+)/)[1]),this.element.find("#media_youtube_width").val(b.width()),this.element.find("#media_youtube_height").val(b.height()),this.element.find("#media_youtube_url").focus()):e.indexOf("http://player.vimeo.com")>-1&&(this.element.find("#media_vimeo_url").val("http://vimeo.com/"+e.match(/\/video\/(\w+)/)[1]),this.element.find("#media_vimeo_width").val(b.width()),this.element.find("#media_vimeo_height").val(b.height()),this.element.find("#media_vimeo_url").focus())));return this.element.find("form").submit(a(function(a){var b,c,d,e,f;a.preventDefault(),e=this.element.find("input[name=media_type]:checked").val();switch(e){case"image_url":c={src:this.element.find("#media_image_url").val()};if(b=this.element.find("#media_image_alignment").val())c.align=b;Mercury.trigger("action",{action:"insertImage",value:c});break;case"youtube_url":d=this.element.find("#media_youtube_url").val().replace("http://youtu.be/",""),f=jQuery("<iframe>",{width:this.element.find("#media_youtube_width").val()||560,height:this.element.find("#media_youtube_height").val()||349,src:"http://www.youtube.com/embed/"+d+"?wmode=transparent",frameborder:0,allowfullscreen:"true"}),Mercury.trigger("action",{action:"insertHTML",value:f});break;case"vimeo_url":d=this.element.find("#media_vimeo_url").val().replace("http://vimeo.com/",""),f=jQuery("<iframe>",{width:this.element.find("#media_vimeo_width").val()||400,height:this.element.find("#media_vimeo_height").val()||225,src:"http://player.vimeo.com/video/"+d+"?title=1&byline=1&portrait=0&color=ffffff",frameborder:0}),Mercury.trigger("action",{action:"insertHTML",value:f})}return this.hide()},this))}}.call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};this.Mercury.modalHandlers.insertSnippet=function(){return this.element.find("form").submit(a(function(a){var b,c;a.preventDefault(),b=this.element.find("form").serializeObject(),Mercury.snippet?(c=Mercury.snippet,c.setOptions(b),Mercury.snippet=null):c=Mercury.Snippet.create(this.options.snippetName,b),Mercury.trigger("action",{action:"insertSnippet",value:c});return this.hide()},this))}}.call(this),function(){var a=function(a,b){return function(){return a.apply(b,arguments)}};this.Mercury.modalHandlers.insertTable=function(){var b,c;c=this.element.find("#table_display table"),c.click(a(function(a){var b;b=jQuery(a.target),c=b.closest("table"),c.find(".selected").removeClass("selected"),b.addClass("selected");return Mercury.tableEditor(c,b,"&nbsp;")},this)),b=c.find("td, th").first(),b.addClass("selected"),Mercury.tableEditor(c,b,"&nbsp;"),this.element.find("input.action").click(a(function(a){var b;b=jQuery(a.target).attr("name");switch(b){case"insertRowBefore":return Mercury.tableEditor.addRow("before");case"insertRowAfter":return Mercury.tableEditor.addRow("after");case"deleteRow":return Mercury.tableEditor.removeRow();case"insertColumnBefore":return Mercury.tableEditor.addColumn("before");case"insertColumnAfter":return Mercury.tableEditor.addColumn("after");case"deleteColumn":return Mercury.tableEditor.removeColumn();case"increaseColspan":return Mercury.tableEditor.increaseColspan();case"decreaseColspan":return Mercury.tableEditor.decreaseColspan();case"increaseRowspan":return Mercury.tableEditor.increaseRowspan();case"decreaseRowspan":return Mercury.tableEditor.decreaseRowspan()}},this)),this.element.find("#table_alignment").change(a(function(){return c.attr({align:this.element.find("#table_alignment").val()})},this)),this.element.find("#table_border").keyup(a(function(){return c.attr({border:parseInt(this.element.find("#table_border").val())})},this)),this.element.find("#table_spacing").keyup(a(function(){return c.attr({cellspacing:parseInt(this.element.find("#table_spacing").val())})},this));return this.element.find("form").submit(a(function(a){var b,d;a.preventDefault(),c.find(".selected").removeClass("selected"),c.find("td, th").html("&nbsp;"),b=jQuery("<div>").html(c).html(),d=b.replace(/^\s+|\n/gm,"").replace(/(<\/.*?>|<table.*?>|<tbody>|<tr>)/g,"$1\n"),Mercury.trigger("action",{action:"insertHTML",value:d});return this.hide()},this))}}.call(this),function(){this.Mercury.loaded=!0,$(function(){return window.Mercury.config.editor==="iframe"?new window.Mercury.IframeEditor:new window.Mercury.InlineEditor})}.call(this)